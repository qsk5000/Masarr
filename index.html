<!DOCTYPE html><html lang="ar" dir="rtl" data-lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Masar V2 | Ù…Ø³Ø§Ø±</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=Noto+Kufi+Arabic:wght@400;700;900&family=Space+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"><style>
:root {
  --gold: #D4AF37; --gold-dark: #AA8A2E; --gold-glow: rgba(212,175,55,0.3);
  --ink: #0A0C10; --surface: #0F1117; --card: #161B22;
  --border: rgba(255,255,255,0.08); --text: #E6EDF3; --muted: #8B949E;
  --teal: #238636; --rose: #DA3633; --purple: #7C3AED; --blue: #1D4ED8;
  --font-ar: 'IBM Plex Sans Arabic', sans-serif;
  --font-en: 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'Space Mono', monospace;
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html[data-lang="en"] { direction: ltr; }
html[data-lang="ar"] { direction: rtl; }
html[data-lang="en"] body { font-family: var(--font-en); }
html[data-lang="ar"] body { font-family: var(--font-ar); }

body { background:var(--ink); color:var(--text); line-height:1.6; overflow-x:hidden; }
body::before { content:''; position:fixed; inset:0; background:radial-gradient(circle at 50% -20%, #1e2631 0%, var(--ink) 70%); z-index:-1; }

/* Lang switcher */
#langBar {
  position:fixed; top:15px; right:15px; z-index:9999;
  display:flex; gap:6px; background:rgba(22,27,34,0.95); 
  border:1px solid var(--border); border-radius:20px; padding:5px 8px;
  backdrop-filter:blur(10px);
}
html[data-lang="en"] #langBar { left:15px; right:auto; }
.lang-btn {
  padding:4px 12px; border-radius:14px; font-size:11px; font-weight:700;
  cursor:pointer; border:none; background:transparent; color:var(--muted); transition:0.2s;
}
.lang-btn.active { background:var(--gold); color:var(--ink); }

/* Cards */
.glass-card {
  background:var(--card); border:1px solid var(--border); border-radius:20px;
  padding:20px; box-shadow:0 4px 20px rgba(0,0,0,0.2);
  transition:transform 0.3s cubic-bezier(0.175,0.885,0.32,1.275), border-color 0.3s;
}
.glass-card:hover { transform:translateY(-4px); border-color:var(--gold); }

/* Bottom Nav */
#bottomNav {
  position:fixed; bottom:20px; left:20px; right:20px; height:65px;
  background:rgba(22,27,34,0.95); backdrop-filter:blur(15px);
  border:1px solid var(--border); border-radius:25px;
  display:flex; justify-content:space-around; align-items:center;
  z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.5);
}
.nav-item {
  position:relative; color:var(--muted); cursor:pointer; transition:all 0.3s;
  display:flex; flex-direction:column; align-items:center;
}
.nav-item.active { color:var(--gold); transform:translateY(-5px); }
.nav-item i { font-size:24px; }
.nav-item span { font-size:10px; font-weight:600; margin-top:2px; }

/* Pages */
@keyframes slideUp { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
.page { display:none; padding:20px 20px 100px; animation:slideUp 0.4s ease forwards; }
.page.active { display:block; }

/* Auth Overlay */
#authOverlay {
  position:fixed; inset:0; background:var(--ink); z-index:10001;
  display:flex; align-items:center; justify-content:center;
}
.auth-card {
  width:90%; max-width:420px; text-align:center;
  background:var(--card); border:1px solid var(--border); border-radius:24px; padding:35px 30px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.auth-logo { font-size:3em; margin-bottom:5px; }
html[data-lang="ar"] .auth-logo { font-family:'Noto Kufi Arabic'; }
html[data-lang="en"] .auth-logo { font-family:var(--font-en); font-weight:800; }

.auth-input {
  width:100%; padding:14px 16px; border-radius:12px;
  border:1px solid var(--border); background:#1c2128; color:white;
  font-size:0.95em; margin-bottom:10px; outline:none; transition:border 0.2s;
}
html[data-lang="ar"] .auth-input { font-family:var(--font-ar); text-align:right; }
html[data-lang="en"] .auth-input { font-family:var(--font-en); text-align:left; }
.auth-input:focus { border-color:var(--gold); }

/* Badges & Buttons */
.mizan-badge {
  background:linear-gradient(45deg, var(--gold), #f3d16e);
  color:var(--ink); padding:2px 8px; border-radius:5px;
  font-size:10px; font-weight:900; vertical-align:middle;
}
.btn-premium {
  background:linear-gradient(45deg, var(--gold), var(--gold-dark));
  color:var(--ink); border:none; padding:13px 25px;
  border-radius:14px; font-weight:900; cursor:pointer;
  box-shadow:0 4px 15px var(--gold-glow); transition:0.3s;
  font-size:0.95em;
}
html[data-lang="ar"] .btn-premium { font-family:var(--font-ar); }
html[data-lang="en"] .btn-premium { font-family:var(--font-en); }
.btn-premium:active { transform:scale(0.95); }
.btn-green { background:linear-gradient(45deg,#238636,#1a6326); color:white; }
.btn-purple { background:linear-gradient(45deg,#7C3AED,#5B21B6); color:white; box-shadow:0 4px 15px rgba(124,58,237,0.3); }

/* Inputs universal */
.field-input {
  width:100%; padding:12px 14px; border-radius:11px; background:#0A0C10;
  border:1px solid var(--border); color:white; outline:none; transition:border 0.2s;
}
html[data-lang="ar"] .field-input { font-family:var(--font-ar); text-align:right; }
html[data-lang="en"] .field-input { font-family:var(--font-en); text-align:left; }
.field-input:focus { border-color:var(--gold); }
.field-label { display:block; margin-bottom:6px; font-size:0.85em; color:var(--muted); }

/* Task items */
.task-item {
  display:flex; align-items:center; gap:12px; padding:13px;
  background:rgba(255,255,255,0.03); border-radius:13px;
  border-inline-end:4px solid var(--gold); margin-bottom:10px;
}
.task-time { font-family:var(--font-mono); color:var(--gold); font-weight:bold; font-size:0.85em; white-space:nowrap; }

/* Toast */
#toast {
  position:fixed; top:20px; left:50%; transform:translateX(-50%);
  background:var(--gold); color:var(--ink); padding:12px 25px;
  border-radius:12px; font-weight:bold; z-index:9999;
  opacity:0; pointer-events:none; transition:0.3s; white-space:nowrap;
}
#toast.show { opacity:1; top:40px; }

/* Schedule grid */
.schedule-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(290px,1fr)); gap:15px; }

/* ============================================================
   GROUP STUDY SYSTEM
   ============================================================ */
.group-room {
  border:1px solid var(--border); border-radius:16px;
  padding:18px; margin-bottom:14px; background:rgba(255,255,255,0.02);
  transition:border-color 0.3s, transform 0.3s;
}
.group-room:hover { border-color:var(--purple); transform:translateY(-3px); }
.group-room-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.group-tag {
  font-size:10px; font-weight:700; padding:3px 9px; border-radius:8px;
  background:rgba(124,58,237,0.2); color:#a78bfa; border:1px solid rgba(124,58,237,0.3);
}
.members-row { display:flex; flex-wrap:wrap; gap:7px; margin:10px 0; }
.member-chip {
  display:flex; align-items:center; gap:5px; padding:4px 10px;
  background:rgba(255,255,255,0.05); border-radius:20px; font-size:12px;
}
.member-dot { width:8px; height:8px; border-radius:50%; background:#22c55e; flex-shrink:0; }
.member-dot.away { background:#f59e0b; }
.member-dot.offline { background:var(--muted); }
.session-timer {
  font-family:var(--font-mono); font-size:1.6em; color:var(--gold);
  text-align:center; padding:12px; background:rgba(212,175,55,0.05);
  border-radius:12px; border:1px solid rgba(212,175,55,0.15); margin:12px 0;
  letter-spacing:3px;
}
.focus-mode-bar {
  display:flex; align-items:center; gap:8px; padding:10px 14px;
  background:rgba(124,58,237,0.1); border-radius:11px;
  border:1px solid rgba(124,58,237,0.2); margin-top:10px; cursor:pointer;
}
.focus-mode-bar i { color:#a78bfa; }

/* Live chat in group room */
.group-chat { max-height:180px; overflow-y:auto; margin:10px 0; padding:0 2px; }
.group-chat::-webkit-scrollbar { width:3px; }
.group-chat::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
.chat-msg {
  display:flex; gap:8px; margin-bottom:8px; align-items:flex-start;
}
html[data-lang="en"] .chat-msg { flex-direction:row; }
html[data-lang="ar"] .chat-msg { flex-direction:row-reverse; }
.chat-avatar {
  width:28px; height:28px; border-radius:50%; flex-shrink:0;
  background:linear-gradient(45deg, var(--purple), var(--gold));
  display:flex; align-items:center; justify-content:center;
  font-size:11px; font-weight:700; color:white;
}
.chat-bubble {
  background:rgba(255,255,255,0.05); border-radius:10px; padding:7px 11px;
  font-size:0.82em; max-width:80%;
}
html[data-lang="ar"] .chat-bubble { border-radius:10px 2px 10px 10px; text-align:right; }
html[data-lang="en"] .chat-bubble { border-radius:2px 10px 10px 10px; text-align:left; }
.chat-name { font-size:10px; color:var(--muted); margin-bottom:2px; }

.chat-input-row { display:flex; gap:8px; margin-top:10px; }
.chat-input-row input { flex:1; padding:9px 13px; border-radius:10px; border:1px solid var(--border); background:#0A0C10; color:white; font-size:0.85em; }
html[data-lang="ar"] .chat-input-row input { text-align:right; font-family:var(--font-ar); }
html[data-lang="en"] .chat-input-row input { text-align:left; font-family:var(--font-en); }
.chat-input-row button { width:38px; height:38px; border-radius:10px; border:none; background:var(--purple); color:white; cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; }

/* Pomodoro widget */
.pomodoro-ring {
  position:relative; width:100px; height:100px; margin:0 auto;
}
.pomodoro-ring svg { transform:rotate(-90deg); }
.pomodoro-ring circle { fill:none; stroke-width:6; }
.ring-bg { stroke:rgba(255,255,255,0.07); }
.ring-progress { stroke:var(--gold); stroke-linecap:round; transition:stroke-dashoffset 1s linear; }
.ring-text {
  position:absolute; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
}
.ring-text span { font-family:var(--font-mono); font-size:1.05em; font-weight:700; }
.ring-text small { font-size:9px; color:var(--muted); }

/* Streak counter */
.streak-flame { font-size:2em; }
@keyframes flicker { 0%,100%{transform:scale(1) rotate(-2deg);} 50%{transform:scale(1.1) rotate(2deg);} }
.streak-flame { animation:flicker 1.5s ease-in-out infinite; display:inline-block; }

/* Stats cards */
.stat-mini {
  text-align:center; padding:16px 12px;
  background:rgba(255,255,255,0.02); border-radius:14px;
  border:1px solid var(--border);
}
.stat-mini .num { font-size:1.8em; font-weight:900; font-family:var(--font-mono); color:var(--gold); }
.stat-mini .lbl { font-size:11px; color:var(--muted); margin-top:4px; }

/* Progress bar */
.prog-bar { background:rgba(255,255,255,0.06); border-radius:99px; height:6px; overflow:hidden; }
.prog-fill { height:100%; border-radius:99px; background:linear-gradient(90deg, var(--gold), #f3d16e); transition:width 0.8s ease; }

/* Section header */
.section-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:18px;
}
.section-title { font-size:1.1em; font-weight:700; }
html[data-lang="ar"] .section-title { font-family:'Noto Kufi Arabic'; }

/* Tabs */
.tabs { display:flex; gap:8px; margin-bottom:20px; overflow-x:auto; padding-bottom:4px; }
.tab-btn {
  padding:7px 16px; border-radius:20px; font-size:12px; font-weight:700;
  cursor:pointer; border:1px solid var(--border); background:transparent;
  color:var(--muted); white-space:nowrap; transition:0.2s;
}
.tab-btn.active { background:var(--gold); color:var(--ink); border-color:var(--gold); }

/* Invite code */
.invite-code {
  font-family:var(--font-mono); font-size:1.4em; font-weight:700;
  color:var(--gold); letter-spacing:5px; text-align:center;
  padding:14px; background:rgba(212,175,55,0.05);
  border:1px dashed rgba(212,175,55,0.3); border-radius:12px; cursor:pointer;
}

/* Notification dot */
.notif-dot {
  position:absolute; top:-2px; right:-2px;
  width:8px; height:8px; background:var(--rose); border-radius:50%;
  border:2px solid var(--ink);
}
html[data-lang="en"] .notif-dot { left:-2px; right:auto; }

/* Arena styles */
.arena-vs {
  display:grid; grid-template-columns:1fr auto 1fr; gap:15px; align-items:center; margin-bottom:20px;
}
.arena-player { text-align:center; padding:15px; background:rgba(255,255,255,0.03); border-radius:14px; }
.arena-vs-badge {
  font-family:var(--font-mono); font-size:1.3em; font-weight:700;
  color:var(--rose); background:rgba(218,54,51,0.1); border-radius:12px;
  padding:10px 8px; border:1px solid rgba(218,54,51,0.2);
}
.q-option {
  padding:13px 16px; border-radius:12px; border:1px solid var(--border);
  cursor:pointer; margin-bottom:8px; transition:0.2s;
  background:rgba(255,255,255,0.02);
}
.q-option:hover { border-color:var(--gold); background:rgba(212,175,55,0.05); }
.q-option.correct { border-color:var(--teal); background:rgba(35,134,54,0.1); }
.q-option.wrong { border-color:var(--rose); background:rgba(218,54,51,0.1); }
</style></head>
<body><!-- Language Switcher --><div id="langBar">
  <button class="lang-btn active" onclick="setLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
  <button class="lang-btn" onclick="setLang('en')">EN</button>
</div><div id="toast"></div><!-- Auth Overlay --><div id="authOverlay">
  <div class="auth-card">
    <div class="auth-logo" id="authLogoText">Ù…Ù€Ø³Ù€Ø§Ø± <span class="mizan-badge">PRO</span></div>
    <p style="color:var(--muted); margin-bottom:28px; font-size:0.9em" id="authSubtitle">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</p>

<input class="auth-input" type="email" id="userEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
<input class="auth-input" type="password" id="userPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">

<p style="text-align: left; font-size: 0.75em; color: var(--gold); cursor: pointer; margin: -5px 5px 15px;" 
   onclick="event.preventDefault(); forgotPassword();" id="forgotPassText">
   Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ
</p>

<button type="button" class="btn-premium" style="width:100%; font-size:1em" onclick="handleAuth()" id="authLoginBtn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©</button>

<button type="button" class="btn-premium" style="width:100%; margin-top:10px; background:white; color:#444; display:flex; align-items:center; justify-content:center; gap:10px;" onclick="loginWithGoogle()">
  <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
  <span id="googleBtnText">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¬ÙˆØ¬Ù„</span>
</button>

<p style="margin-top:14px; font-size:0.8em; color:var(--muted); cursor:pointer" onclick="toggleAuthMode()" id="authSignupLink">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</p>


</div>
</div><!-- Bottom Nav --><nav id="bottomNav" style="display:none">
  <div class="nav-item active" onclick="goPage('pageSetup')" data-page="pageSetup">
    <i class="ri-settings-4-fill"></i><span data-i18n="nav.setup">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</span>
  </div>
  <div class="nav-item" onclick="goPage('pageSchedule')" data-page="pageSchedule">
    <i class="ri-calendar-event-fill"></i><span data-i18n="nav.schedule">Ø§Ù„Ø¬Ø¯ÙˆÙ„</span>
  </div>
  <div class="nav-item" onclick="goPage('pageGroup')" data-page="pageGroup">
    <i class="ri-team-fill"></i>
    <span data-i18n="nav.group">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
    <div class="notif-dot" id="groupNotif" style="display:none"></div>
  </div>
  <div class="nav-item" onclick="goPage('pageArena')" data-page="pageArena">
    <i class="ri-sword-fill"></i><span data-i18n="nav.arena">Ø§Ù„ØªØ­Ø¯ÙŠ</span>
  </div>
  <div class="nav-item" onclick="goPage('pageMizan')" data-page="pageMizan">
    <i class="ri-shield-check-fill"></i><span data-i18n="nav.mizan">Ø§Ù„Ù…ÙŠØ²Ø§Ù†</span>
  </div>
</nav><!-- ========== PAGE: SETUP ========== --><div id="pageSetup" class="page active">
  <h2 style="font-family:'Noto Kufi Arabic'; margin-bottom:20px;" data-i18n="setup.title">ØªØ®ØµÙŠØµ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ§ </h2>
  <div class="glass-card" style="margin-bottom:20px">
    <div style="margin-bottom:18px">
      <label class="field-label" data-i18n="setup.name">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="studentName" class="field-input">
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:18px">
      <div>
        <label class="field-label" data-i18n="setup.level">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <select id="studyLevel" class="field-input">
          <option value="6" data-i18n-opt="level.6">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="3" data-i18n-opt="level.3">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
          <option value="univ" data-i18n-opt="level.univ">Ø¬Ø§Ù…Ø¹Ø©</option>
          <option value="other" data-i18n-opt="level.other">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div>
        <label class="field-label" data-i18n="setup.peak">ÙˆÙ‚Øª Ø°Ø±ÙˆØ© Ø§Ù„Ù†Ø´Ø§Ø·</label>
        <select id="peakTime" class="field-input">
          <option value="morning" data-i18n-opt="peak.morning">ØµØ¨Ø§Ø­Ø§Ù‹ / ÙØ¬Ø±Ø§Ù‹</option>
          <option value="evening" data-i18n-opt="peak.evening">Ù…Ø³Ø§Ø¡Ù‹</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:18px">
      <label class="field-label" data-i18n="setup.lang">Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</label>
      <select id="appLang" class="field-input" onchange="setLang(this.value)">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>
    </div>
    <button class="btn-premium" style="width:100%" onclick="saveProfile()" data-i18n="setup.save">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div><div class="section-header">
    <span class="section-title" data-i18n="setup.subjects">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</span>
  </div>
  <div class="glass-card" style="border-style:dashed; margin-bottom:14px">
    <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px; margin-bottom:10px">
      <input type="text" id="subjName" class="field-input" placeholder="ÙƒÙŠÙ…ÙŠØ§Ø¡ØŒ ÙÙŠØ²ÙŠØ§Ø¡..." data-i18n-ph="subj.placeholder">
      <select id="subjDiff" class="field-input">
        <option value="3" data-i18n-opt="diff.hard">ØµØ¹Ø¨Ø©</option>
        <option value="2" data-i18n-opt="diff.med">Ù…ØªÙˆØ³Ø·Ø©</option>
        <option value="1" data-i18n-opt="diff.easy">Ø³Ù‡Ù„Ø©</option>
      </select>
    </div>
    <button class="btn-premium btn-green" style="width:100%" onclick="addSubject()" data-i18n="setup.addSubj">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³Ø§Ø±</button>
  </div>
  <div id="subjectsList"></div>
  <button class="btn-premium" style="width:100%; margin-top:25px; font-size:1.15em" onclick="generateAISchedule()" data-i18n="setup.generate">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
</div><!-- ========== PAGE: SCHEDULE ========== --><div id="pageSchedule" class="page">
  <div class="glass-card" style="background:linear-gradient(135deg,#161B22 0%,#0A0C10 100%); margin-bottom:20px">
    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px">
      <div>
        <h2 id="welcomeMsg" style="color:var(--gold); font-family:'Noto Kufi Arabic';" data-i18n="schedule.waiting">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„Ùƒ...</h2>
        <p id="progressStat" style="color:var(--muted); font-size:0.85em" data-i18n="schedule.progress">Ø£Ù†Ø¬Ø² Ù…Ù‡Ø§Ù…Ùƒ Ù„ØªØ±ÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ</p>
      </div>
      <div style="text-align:center">
        <div class="streak-flame">ğŸ”¥</div>
        <div style="font-family:var(--font-mono); font-size:1.4em; font-weight:700;" id="streakNum">0</div>
        <div style="font-size:10px; color:var(--muted)" data-i18n="schedule.streak">ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„</div>
      </div>
    </div>
    <div style="margin-top:14px">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:6px">
        <span data-i18n="schedule.today">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</span><span id="todayPct">0%</span>
      </div>
      <div class="prog-bar"><div class="prog-fill" id="todayProg" style="width:0%"></div></div>
    </div>
  </div><!-- Quick Stats --><div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:20px">
    <div class="stat-mini"><div class="num" id="totalHours">0</div><div class="lbl" data-i18n="stat.hours">Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³Ø©</div></div>
    <div class="stat-mini"><div class="num" id="completedTasks">0</div><div class="lbl" data-i18n="stat.tasks">Ù…Ù‡Ù…Ø© Ù…Ù†Ø¬Ø²Ø©</div></div>
    <div class="stat-mini"><div class="num" id="rankVal">â€“</div><div class="lbl" data-i18n="stat.rank">Ø§Ù„ØªØ±ØªÙŠØ¨</div></div>
  </div><div id="scheduleContainer" class="schedule-grid"></div>
</div><!-- ========== PAGE: GROUP STUDY ========== --><div id="pageGroup" class="page">
  <div style="margin-bottom:20px">
    <h2 style="font-family:'Noto Kufi Arabic';" data-i18n="group.title">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>
    <p style="color:var(--muted); font-size:0.85em; margin-top:5px" data-i18n="group.subtitle">Ø§Ø¯Ø±Ø³ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ ÙˆÙ‚Øª ÙˆØ§Ø­Ø¯</p>
  </div><!-- Tabs --><div class="tabs">
    <button class="tab-btn active" onclick="groupTab('myRoom')" id="tabMyRoom" data-i18n="group.tab.myRoom">ØºØ±ÙØªÙŠ</button>
    <button class="tab-btn" onclick="groupTab('joinRoom')" id="tabJoinRoom" data-i18n="group.tab.join">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</button>
    <button class="tab-btn" onclick="groupTab('leaderboard')" id="tabLeader" data-i18n="group.tab.leader">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</button>
  </div><!-- My Room tab --><div id="groupTabMyRoom">
    <div class="glass-card" style="margin-bottom:15px">
      <div class="group-room-header">
        <div>
          <strong id="myRoomName" data-i18n="group.myRoom">ØºØ±ÙØªÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</strong>
          <div class="group-tag" style="display:inline-block; margin-inline-start:8px" data-i18n="group.live">ğŸ”´ Ù…Ø¨Ø§Ø´Ø±</div>
        </div>
        <i class="ri-share-line" style="color:var(--gold); cursor:pointer; font-size:20px" onclick="shareRoom()"></i>
      </div>

  <!-- Invite Code -->
  <div class="invite-code" id="myInviteCode" onclick="copyCode()">MAS-XXXX</div>
  <p style="text-align:center; font-size:11px; color:var(--muted); margin-top:6px" data-i18n="group.tapCopy">Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</p>

  <!-- Session Timer -->
  <div class="session-timer" id="sessionTimer">00:00:00</div>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px">
    <button class="btn-premium" onclick="toggleSession()" id="sessionBtn" data-i18n="group.startSession">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    <button class="btn-premium" style="background:rgba(255,255,255,0.06); color:var(--text); box-shadow:none" onclick="endSession()" data-i18n="group.endSession">â¬› Ø¥Ù†Ù‡Ø§Ø¡</button>
  </div>

  <!-- Pomodoro -->
  <div style="margin-top:18px; padding-top:15px; border-top:1px solid var(--border)">
    <div style="text-align:center; margin-bottom:10px; font-size:0.85em; font-weight:600" data-i18n="group.pomodoro">Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</div>
    <div class="pomodoro-ring">
      <svg width="100" height="100" viewBox="0 0 100 100">
        <circle class="ring-bg" cx="50" cy="50" r="42"/>
        <circle class="ring-progress" cx="50" cy="50" r="42" id="pomRing"
          stroke-dasharray="263.9" stroke-dashoffset="0"/>
      </svg>
      <div class="ring-text">
        <span id="pomTime">25:00</span>
        <small id="pomLabel" data-i18n="pom.focus">ØªØ±ÙƒÙŠØ²</small>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:center">
      <button class="btn-premium" style="padding:8px 18px; font-size:0.85em" onclick="togglePomodoro()" id="pomBtn" data-i18n="pom.start">Ø¨Ø¯Ø¡</button>
      <button class="btn-premium" style="padding:8px 18px; font-size:0.85em; background:rgba(255,255,255,0.06); color:var(--text); box-shadow:none" onclick="resetPomodoro()" data-i18n="pom.reset">Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>
  </div>

  <!-- Focus Mode -->
  <div class="focus-mode-bar" onclick="toggleFocusMode()" id="focusModeBar">
    <i class="ri-focus-3-line"></i>
    <span style="flex:1; font-size:0.9em" data-i18n="group.focusMode">ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØµØ§Ù…Øª</span>
    <div id="focusToggle" style="width:36px; height:20px; background:rgba(255,255,255,0.1); border-radius:10px; position:relative; transition:0.3s">
      <div id="focusBall" style="position:absolute; width:16px; height:16px; background:var(--muted); border-radius:50%; top:2px; right:2px; transition:0.3s"></div>
    </div>
  </div>
</div>

<!-- Members List -->
<div class="glass-card" style="margin-bottom:15px">
  <div class="section-header">
    <span class="section-title" data-i18n="group.members">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†</span>
    <span style="font-size:12px; color:var(--muted)" id="membersCount">0 / 8</span>
  </div>
  <div class="members-row" id="membersList"></div>
</div>

<!-- Group Chat -->
<div class="glass-card">
  <div class="section-header">
    <span class="section-title" data-i18n="group.chat">Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
    <i class="ri-message-3-line" style="color:var(--muted)"></i>
  </div>
  <div class="group-chat" id="groupChat"></div>
  <div class="chat-input-row">
    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." data-i18n-ph="chat.placeholder" onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()"><i class="ri-send-plane-fill"></i></button>
  </div>
</div>


</div><!-- Join Room tab --><div id="groupTabJoinRoom" style="display:none">
    <div class="glass-card" style="margin-bottom:15px">
      <h4 style="margin-bottom:14px" data-i18n="group.joinTitle">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©</h4>
      <input type="text" id="joinCode" class="field-input" placeholder="MAS-XXXX" style="text-align:center; font-family:var(--font-mono); font-size:1.2em; letter-spacing:3px; margin-bottom:10px">
      <button class="btn-premium" style="width:100%" onclick="joinRoom()" data-i18n="group.join">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
    </div>
    <div class="glass-card">
      <h4 style="margin-bottom:14px" data-i18n="group.publicRooms">ØºØ±Ù Ø¹Ø§Ù…Ø© Ù…ÙØªÙˆØ­Ø©</h4>
      <div id="publicRoomsList"></div>
    </div>
  </div><!-- Leaderboard tab --><div id="groupTabLeaderboard" style="display:none">
    <div class="glass-card">
      <h4 style="margin-bottom:16px" data-i18n="group.weeklyLeader">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h4>
      <div id="leaderboardList"></div>
    </div>
  </div>
</div><!-- ========== PAGE: ARENA ========== --><div id="pageArena" class="page">
  <h2 style="font-family:'Noto Kufi Arabic'; margin-bottom:20px" data-i18n="arena.title">âš”ï¸ Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
  <div id="arenaLobby">
    <div class="glass-card" style="text-align:center; margin-bottom:15px; padding:30px">
      <i class="ri-sword-fill" style="font-size:50px; color:var(--gold)"></i>
      <h3 style="margin:10px 0" data-i18n="arena.ready">Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©ØŸ</h3>
      <p style="color:var(--muted); font-size:0.9em; margin-bottom:20px" data-i18n="arena.desc">ØªÙ†Ø§ÙØ³ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¯ Ù…Ø®ØªÙ„ÙØ©</p>
      <button class="btn-premium" style="margin-bottom:10px; width:100%" onclick="findArenaMatch()" data-i18n="arena.findMatch">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³</button>
      <button class="btn-premium btn-purple" style="width:100%" onclick="startSoloChallenge()" data-i18n="arena.solo">ğŸ¯ ØªØ­Ø¯ÙŠ ÙØ±Ø¯ÙŠ</button>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
      <div class="stat-mini"><div class="num" id="arenaWins">0</div><div class="lbl" data-i18n="arena.wins">Ø§Ù†ØªØµØ§Ø±Ø§Øª</div></div>
      <div class="stat-mini"><div class="num" id="arenaRating">1000</div><div class="lbl" data-i18n="arena.rating">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div></div>
    </div>
  </div>
  <div id="arenaGame" style="display:none">
    <div class="arena-vs">
      <div class="arena-player">
        <div style="font-size:1.5em; margin-bottom:5px">ğŸ§‘</div>
        <div style="font-weight:700; font-size:0.9em" id="player1Name">Ø£Ù†Øª</div>
        <div style="font-family:var(--font-mono); color:var(--gold); font-size:1.4em" id="player1Score">0</div>
      </div>
      <div class="arena-vs-badge">VS</div>
      <div class="arena-player">
        <div style="font-size:1.5em; margin-bottom:5px">ğŸ¤–</div>
        <div style="font-weight:700; font-size:0.9em" id="player2Name">Ù…Ù†Ø§ÙØ³</div>
        <div style="font-family:var(--font-mono); color:var(--rose); font-size:1.4em" id="player2Score">0</div>
      </div>
    </div>
    <div class="glass-card">
      <div style="font-size:12px; color:var(--muted); margin-bottom:10px">
        <span data-i18n="arena.question">Ø§Ù„Ø³Ø¤Ø§Ù„</span> <span id="qNum">1</span>/5 &nbsp;|&nbsp;
        <span id="qTimer" style="color:var(--gold); font-family:var(--font-mono)">10</span>s
      </div>
      <p id="qText" style="font-size:1.05em; font-weight:600; margin-bottom:16px; line-height:1.5"></p>
      <div id="qOptions"></div>
    </div>
  </div>
</div><!-- ========== PAGE: MIZAN ========== --><div id="pageMizan" class="page">
  <div style="text-align:center; padding:30px 0 20px">
    <i class="ri-shield-flash-line" style="font-size:70px; color:var(--gold)"></i>
    <h1 style="font-family:'Noto Kufi Arabic'; margin-top:8px">Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙŠØ²Ø§Ù† <span class="mizan-badge">LMS</span></h1>
    <p style="color:var(--muted); font-size:0.85em" data-i18n="mizan.subtitle">ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</p>
  </div>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px">
    <div class="stat-mini"><div class="num">95%</div><div class="lbl" data-i18n="mizan.commit">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div></div>
    <div class="stat-mini"><div class="num">120<small style="font-size:12px">h</small></div><div class="lbl" data-i18n="mizan.focus">Ø§Ù„ØªØ±ÙƒÙŠØ²</div></div>
    <div class="stat-mini"><div class="num" id="mizanStreak">0</div><div class="lbl" data-i18n="mizan.streak">ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„</div></div>
    <div class="stat-mini"><div class="num" id="mizanGroups">0</div><div class="lbl" data-i18n="mizan.groups">Ø¬Ù„Ø³Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</div></div>
  </div>
  <div class="glass-card">
    <h3 style="margin-bottom:12px">ğŸ›¡ï¸ <span data-i18n="mizan.protection">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±</span></h3>
    <p style="font-size:0.85em; color:var(--muted)" data-i18n="mizan.desc">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù† ÙŠØ±Ø³Ù„ ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ØªØªØ¶Ù…Ù† Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²ØŒ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª.</p>
    <div style="margin-top:15px">
      <div style="display:flex; justify-content:space-between; font-size:12px; color:var(--muted); margin-bottom:5px">
        <span data-i18n="mizan.weeklyGoal">Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span><span>72%</span>
      </div>
      <div class="prog-bar"><div class="prog-fill" style="width:72%"></div></div>
    </div>
  </div>
</div><!-- Firebase SDKs --><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script><script>
// ===========================
// i18n â€“ Internationalization
// ===========================
const i18n = {
  ar: {
    "nav.setup":"Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯","nav.schedule":"Ø§Ù„Ø¬Ø¯ÙˆÙ„","nav.group":"Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©","nav.arena":"Ø§Ù„ØªØ­Ø¯ÙŠ","nav.mizan":"Ø§Ù„Ù…ÙŠØ²Ø§Ù†",
    "setup.title":"ØªØ®ØµÙŠØµ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ§ ","setup.name":"Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„","setup.level":"Ø§Ù„Ù…Ø±Ø­Ù„Ø©","setup.peak":"ÙˆÙ‚Øª Ø°Ø±ÙˆØ© Ø§Ù„Ù†Ø´Ø§Ø·",
    "setup.lang":"Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚","setup.save":"Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª","setup.subjects":"Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©",
    "setup.addSubj":"ï¼‹ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³Ø§Ø±","setup.generate":"âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
    "schedule.waiting":"Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„Ùƒ...","schedule.progress":"Ø£Ù†Ø¬Ø² Ù…Ù‡Ø§Ù…Ùƒ Ù„ØªØ±ÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ",
    "schedule.streak":"ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„","schedule.today":"Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…",
    "stat.hours":"Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³Ø©","stat.tasks":"Ù…Ù‡Ù…Ø© Ù…Ù†Ø¬Ø²Ø©","stat.rank":"Ø§Ù„ØªØ±ØªÙŠØ¨",
    "group.title":"ğŸ§‘â€ğŸ¤â€ğŸ§‘ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©","group.subtitle":"Ø§Ø¯Ø±Ø³ Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ ÙÙŠ ÙˆÙ‚Øª ÙˆØ§Ø­Ø¯",
    "group.tab.myRoom":"ØºØ±ÙØªÙŠ","group.tab.join":"Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…","group.tab.leader":"Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†",
    "group.myRoom":"ØºØ±ÙØªÙŠ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©","group.live":"ğŸ”´ Ù…Ø¨Ø§Ø´Ø±","group.tapCopy":"Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®",
    "group.startSession":"â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©","group.endSession":"â¬› Ø¥Ù†Ù‡Ø§Ø¡","group.pomodoro":"Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ",
    "group.focusMode":"ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØµØ§Ù…Øª","group.members":"Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙˆÙ†","group.chat":"Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©",
    "group.joinTitle":"Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©","group.join":"Ø§Ù†Ø¶Ù…Ø§Ù…","group.publicRooms":"ØºØ±Ù Ø¹Ø§Ù…Ø© Ù…ÙØªÙˆØ­Ø©",
    "group.weeklyLeader":"ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
    "pom.focus":"ØªØ±ÙƒÙŠØ²","pom.break":"Ø§Ø³ØªØ±Ø§Ø­Ø©","pom.start":"Ø¨Ø¯Ø¡","pom.reset":"Ø¥Ø¹Ø§Ø¯Ø©",
    "arena.title":"âš”ï¸ Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø¯ÙŠ","arena.ready":"Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©ØŸ",
    "arena.desc":"ØªÙ†Ø§ÙØ³ Ù…Ø¹ Ø²Ù…Ù„Ø§Ø¦Ùƒ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¯ Ù…Ø®ØªÙ„ÙØ©","arena.findMatch":"ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³",
    "arena.solo":"ğŸ¯ ØªØ­Ø¯ÙŠ ÙØ±Ø¯ÙŠ","arena.wins":"Ø§Ù†ØªØµØ§Ø±Ø§Øª","arena.rating":"Ø§Ù„ØªÙ‚ÙŠÙŠÙ…","arena.question":"Ø§Ù„Ø³Ø¤Ø§Ù„",
    "mizan.subtitle":"ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ","mizan.commit":"Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…","mizan.focus":"Ø§Ù„ØªØ±ÙƒÙŠØ²",
    "mizan.streak":"ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„","mizan.groups":"Ø¬Ù„Ø³Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©","mizan.protection":"Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±",
    "mizan.desc":"Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù† ÙŠØ±Ø³Ù„ ØªÙ‚Ø§Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¥Ù„Ù‰ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ØªØªØ¶Ù…Ù† Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²ØŒ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª.",
    "mizan.weeklyGoal":"Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹",
    "level.6":"Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ","level.3":"Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·","level.univ":"Ø¬Ø§Ù…Ø¹Ø©","level.other":"Ø£Ø®Ø±Ù‰",
    "peak.morning":"ØµØ¨Ø§Ø­Ø§Ù‹ / ÙØ¬Ø±Ø§Ù‹","peak.evening":"Ù…Ø³Ø§Ø¡Ù‹",
    "diff.hard":"ØµØ¹Ø¨Ø©","diff.med":"Ù…ØªÙˆØ³Ø·Ø©","diff.easy":"Ø³Ù‡Ù„Ø©",
    "subj.placeholder":"ÙƒÙŠÙ…ÙŠØ§Ø¡ØŒ ÙÙŠØ²ÙŠØ§Ø¡...","chat.placeholder":"Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...",
    "auth.title":"Ù…Ù€Ø³Ù€Ø§Ø±","auth.subtitle":"Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ",
    "auth.email":"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ","auth.pass":"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±","auth.login":"Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©","auth.signup":"Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†"
  },
  en: {
    "nav.setup":"Setup","nav.schedule":"Schedule","nav.group":"Study Group","nav.arena":"Arena","nav.mizan":"Tracker",
    "setup.title":"Customize Your Smart Plan ğŸ§ ","setup.name":"Full Name","setup.level":"Grade","setup.peak":"Peak Activity Time",
    "setup.lang":"App Language","setup.save":"Save Profile","setup.subjects":"Add Study Subjects",
    "setup.addSubj":"ï¼‹ Add Subject","setup.generate":"âœ¨ Generate AI Schedule",
    "schedule.waiting":"Waiting for your schedule...","schedule.progress":"Complete tasks to level up",
    "schedule.streak":"Day Streak","schedule.today":"Today's Progress",
    "stat.hours":"Study Hours","stat.tasks":"Tasks Done","stat.rank":"Rank",
    "group.title":"ğŸ§‘â€ğŸ¤â€ğŸ§‘ Group Study","group.subtitle":"Study together with your friends in real time",
    "group.tab.myRoom":"My Room","group.tab.join":"Join","group.tab.leader":"Leaderboard",
    "group.myRoom":"My Study Room","group.live":"ğŸ”´ Live","group.tapCopy":"Tap to copy",
    "group.startSession":"â–¶ Start Session","group.endSession":"â¬› End","group.pomodoro":"Group Pomodoro Timer",
    "group.focusMode":"Silent Focus Mode","group.members":"Active Members","group.chat":"Group Chat",
    "group.joinTitle":"Join with Invite Code","group.join":"Join","group.publicRooms":"Open Public Rooms",
    "group.weeklyLeader":"ğŸ† This Week's Leaders",
    "pom.focus":"Focus","pom.break":"Break","pom.start":"Start","pom.reset":"Reset",
    "arena.title":"âš”ï¸ Challenge Arena","arena.ready":"Ready to Compete?",
    "arena.desc":"Challenge classmates in quick subject-based quizzes","arena.findMatch":"ğŸ” Find Opponent",
    "arena.solo":"ğŸ¯ Solo Challenge","arena.wins":"Wins","arena.rating":"Rating","arena.question":"Question",
    "mizan.subtitle":"Track your academic performance & progress","mizan.commit":"Commitment","mizan.focus":"Focus Hours",
    "mizan.streak":"Day Streak","mizan.groups":"Group Sessions","mizan.protection":"Path Protection",
    "mizan.desc":"Mizan automatically sends daily reports to your guardian including completion rate, actual study start time, and arena results.",
    "mizan.weeklyGoal":"Weekly Goal",
    "level.6":"Grade 12","level.3":"Grade 9","level.univ":"University","level.other":"Other",
    "peak.morning":"Morning / Dawn","peak.evening":"Evening",
    "diff.hard":"Hard","diff.med":"Medium","diff.easy":"Easy",
    "subj.placeholder":"Chemistry, Physics...","chat.placeholder":"Type a message...",
    "auth.title":"Masar","auth.subtitle":"Smart Education Management System",
    "auth.email":"Email Address","auth.pass":"Password","auth.login":"Enter Platform","auth.signup":"No account? Sign up"
  }
};

let currentLang = 'ar';

function t(key) { return (i18n[currentLang] && i18n[currentLang][key]) || i18n['ar'][key] || key; }

function setLang(lang) {
  currentLang = lang;
  document.documentElement.setAttribute('lang', lang);
  document.documentElement.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
  document.documentElement.setAttribute('data-lang', lang);
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const k = el.getAttribute('data-i18n');
    el.textContent = t(k);
  });
  document.querySelectorAll('[data-i18n-ph]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-ph'));
  });
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.textContent.trim() === (lang==='ar'?'Ø¹Ø±Ø¨ÙŠ':'EN')));
  document.getElementById('appLang').value = lang;
  // Update auth
  document.getElementById('authLogoText').innerHTML = (lang==='ar'?'Ù…Ù€Ø³Ù€Ø§Ø±':'Masar') + ' <span class="mizan-badge">PRO</span>';
  document.getElementById('authSubtitle').textContent = t('auth.subtitle');
  document.getElementById('userEmail').placeholder = t('auth.email');
  document.getElementById('userPass').placeholder = t('auth.pass');
  document.getElementById('authLoginBtn').textContent = t('auth.login');
  document.getElementById('authSignupLink').textContent = t('auth.signup');
  if(userProfile.schedule.length > 0) renderSchedule();
  renderSubjects();
}

// ========================================== // ===========================
// Firebase Setup
// ========================================== 
// 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (ØªØ¹Ø±ÙŠÙ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·)
// ========================================== 
const firebaseConfig = {
  apiKey: "AIzaSyDeBAgXm6L3NPTitSuzkS37ZFoyy_UvMHk",
  authDomain: "masar-5db30.firebaseapp.com",
  projectId: "masar-5db30",
  storageBucket: "masar-5db30.firebasestorage.app",
  messagingSenderId: "909223400853",
  appId: "1:909223400853:web:a64c4e243de8c1dc15d29c"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const db = firebase.firestore();
const auth = firebase.auth();

// Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
let currentUser = null;
let authMode = 'login'; 
let userProfile = { name:"", subjects:[], schedule:[], streak:0, completedTasks:0, totalHours:0 };

// ========================================== 
// 2. Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
// ========================================== 

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù‡Ù„ Ù‡Ùˆ Ø¯Ø§Ø®Ù„ Ø£Ù… Ø®Ø§Ø±Ø¬ØŸ)
auth.onAuthStateChanged(user => {
  if(user) {
    currentUser = user;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('bottomNav').style.display = 'flex';
    loadUserData(user.uid);
    initGroupRoom();
  } else {
    document.getElementById('authOverlay').style.display = 'flex';
    document.getElementById('bottomNav').style.display = 'none';
  }
});

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
function toggleAuthMode() {
  authMode = (authMode === 'login') ? 'signup' : 'login';
  const loginBtn = document.getElementById('authLoginBtn');
  const signupLink = document.getElementById('authSignupLink');
  
  if (authMode === 'signup') {
    loginBtn.textContent = currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Create Account';
    signupLink.textContent = currentLang === 'ar' ? 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„' : 'Have an account? Login';
  } else {
    loginBtn.textContent = currentLang === 'ar' ? 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©' : 'Enter Platform';
    signupLink.textContent = currentLang === 'ar' ? 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†' : 'No account? Sign up';
  }
}


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø¯Ø®ÙˆÙ„ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„)
async function handleAuth() {
  const email = document.getElementById('userEmail').value.trim();
  const pass = document.getElementById('userPass').value;
  
  if(!email || !pass) return showToast(currentLang === 'ar' ? 'âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'âš ï¸ Enter credentials');

  try {
    if(authMode === 'signup') {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
      const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙÙˆØ±Ø§Ù‹
      await userCredential.user.sendEmailVerification();
      
      showToast(currentLang === 'ar' ? 'ğŸ“§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! ØªÙÙ‚Ø¯ Ø¨Ø±ÙŠØ¯Ùƒ Ù„ØªØ£ÙƒÙŠØ¯Ù‡' : 'ğŸ“§ Account created! Check email to verify');
    } else {
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      await auth.signInWithEmailAndPassword(email, pass);
      showToast(currentLang === 'ar' ? 'âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'âœ… Logged in');
    }
  } catch(e) { 
      console.error(e);
      // ØªØ±Ø¬Ù…Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
      let msg = e.message;
      if(e.code === 'auth/email-already-in-use') msg = "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„";
      if(e.code === 'auth/weak-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹";
      showToast("âŒ " + msg); 
  }
}

//
// Ø¯Ø§Ù„Ø© Ù†Ø³ÙŠØ§Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
async function forgotPassword() {
  const emailInput = document.getElementById('userEmail');
  const email = emailInput.value.trim();

  if (!email) {
    showToast(currentLang === 'ar' ? 'âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¨Ø±ÙŠØ¯Ùƒ Ø£ÙˆÙ„Ø§Ù‹' : 'âš ï¸ Please enter your email first');
    return;
  }

  try {
    // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†
    await firebase.auth().sendPasswordResetEmail(email);
    showToast(currentLang === 'ar' ? 'ğŸ“§ Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„Ø¨Ø±ÙŠØ¯Ùƒ' : 'ğŸ“§ Reset link sent to your email');
  } catch (error) {
    console.error(error);
    if (error.code === 'auth/user-not-found') {
      showToast(currentLang === 'ar' ? 'âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ User not found');
    } else {
      showToast("âŒ " + error.message);
    }
  }
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„

async function loginWithGoogle() {
  try {
    const provider = new firebase.auth.GoogleAuthProvider();
    // Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¹Ù…Ù„ Refresh ÙˆÙŠÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
    const result = await auth.signInWithPopup(provider);
    showToast(currentLang === 'ar' ? 'âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„' : 'âœ… Logged in with Google');
  } catch (e) {
    console.error(e);
    if(e.code === 'auth/operation-not-supported-in-this-environment') {
        showToast("âš ï¸ Ø¬ÙˆØ¬Ù„ Ù„Ø§ ÙŠØ¹Ù…Ù„ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· (Hosting)");
    } else {
        showToast("âŒ " + e.message);
    }
  }
}

// ========================================== 
// 3. Ø¨Ù‚ÙŠØ© Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø¥Ù„Ø®)
// ========================================== 

async function loadUserData(uid) {
  const doc = await db.collection('users').doc(uid).get();
  if(doc.exists) {
    userProfile = { ...userProfile, ...doc.data() };
    document.getElementById('studentName').value = userProfile.name || '';
    renderSubjects();
    if(userProfile.schedule && userProfile.schedule.length > 0) renderSchedule();
    updateStats();
  }
}

async function saveProfile() {
  if(!currentUser) return;
  userProfile.name = document.getElementById('studentName').value;
  await db.collection('users').doc(currentUser.uid).set(userProfile, { merge: true });
  showToast("ğŸ’¾ " + (currentLang==='ar'?'ØªÙ… Ø§Ù„Ø­ÙØ¸':'Saved'));
}

// [ØªÙƒÙ…Ù„Ø© Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ø¯ÙŠÙƒ: addSubject, generateAISchedule, Ø¥Ù„Ø®...]


// ===========================
// Subjects
// ===========================
function addSubject() {
  const name = document.getElementById('subjName').value.trim();
  const diff = parseInt(document.getElementById('subjDiff').value);
  if(!name) return showToast(currentLang==='ar'?'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©':'Enter subject name');
  userProfile.subjects = userProfile.subjects || [];
  userProfile.subjects.push({ id: Date.now(), name, diff });
  document.getElementById('subjName').value = '';
  renderSubjects();
  saveProfile();
}

function removeSubject(id) {
  userProfile.subjects = userProfile.subjects.filter(s => s.id !== id);
  renderSubjects();
  saveProfile();
}

function renderSubjects() {
  const c = document.getElementById('subjectsList');
  if(!userProfile.subjects || !userProfile.subjects.length) { c.innerHTML=''; return; }
  c.innerHTML = userProfile.subjects.map(s => `
    <div class="task-item" style="border-inline-end-color:${s.diff===3?'var(--rose)':'var(--gold)'}">
      <div style="flex:1"><strong>${s.name}</strong></div>
      <div style="font-size:0.75em; color:var(--muted)">${s.diff===3?t('diff.hard'):s.diff===2?t('diff.med'):t('diff.easy')}</div>
      <i class="ri-delete-bin-line" style="color:var(--rose); cursor:pointer" onclick="removeSubject(${s.id})"></i>
    </div>
  `).join('');
}

// ===========================
// AI Schedule
// ===========================
function generateAISchedule() {
  if(!userProfile.subjects || !userProfile.subjects.length) return showToast(currentLang==='ar'?'Ø£Ø¶Ù Ù…ÙˆØ§Ø¯ Ø£ÙˆÙ„Ø§Ù‹!':'Add subjects first!');
  showToast('ğŸª„ ' + (currentLang==='ar'?'Ø¬Ø§Ø±Ù ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...':'Analyzing data...'));
  const peak = document.getElementById('peakTime').value;

  const daysAr = ['Ø§Ù„Ø³Ø¨Øª','Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©'];
  const daysEn = ['Saturday','Sunday','Monday','Tuesday','Wednesday','Thursday','Friday'];
  
  const sortedSubjs = [...userProfile.subjects].sort((a,b) => b.diff - a.diff);
  let schedule = [];

  for(let i = 0; i < 7; i++) {
    const subj1 = sortedSubjs[i % sortedSubjs.length];
    const subj2 = sortedSubjs[(i+1) % sortedSubjs.length];
    schedule.push({
      dayAr: daysAr[i], dayEn: daysEn[i],
      tasks: [
        { time: peak==='morning'?"05:00":"16:00", subject: subj1.name, typeAr:'ØªØ±ÙƒÙŠØ² Ø¹Ù…ÙŠÙ‚', typeEn:'Deep Focus', done: false },
        { time: peak==='morning'?"09:00":"20:00", subject: subj2.name, typeAr:'Ù…Ø±Ø§Ø¬Ø¹Ø©', typeEn:'Review', done: false }
      ]
    });
  }

  userProfile.schedule = schedule;
  renderSchedule();
  saveProfile();
  goPage('pageSchedule');
}

function renderSchedule() {
  const c = document.getElementById('scheduleContainer');
  const wm = document.getElementById('welcomeMsg');
  if(userProfile.name) wm.textContent = (currentLang==='ar'?'Ø®Ø·Ø© ':'Plan of ') + userProfile.name;
  
  c.innerHTML = (userProfile.schedule||[]).map((day, di) => `
    <div class="glass-card">
      <h4 style="color:var(--gold); border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:14px;">
        ${currentLang==='ar' ? day.dayAr : day.dayEn}
      </h4>
      ${(day.tasks||[]).map((t, ti) => `
        <div class="task-item" style="opacity:${t.done?0.5:1}">
          <div class="task-time">${t.time}</div>
          <div style="flex:1">
            <div style="font-weight:bold; ${t.done?'text-decoration:line-through':''}">${t.subject}</div>
            <div style="font-size:0.75em; color:var(--muted)">${currentLang==='ar'?t.typeAr:t.typeEn}</div>
          </div>
          <i class="ri-checkbox-circle-${t.done?'fill':'line'}" style="font-size:22px; color:${t.done?'var(--teal)':'var(--muted)'}; cursor:pointer"
            onclick="toggleTask(${di},${ti})"></i>
        </div>
      `).join('')}
    </div>
  `).join('');
  updateStats();
}

function toggleTask(di, ti) {
  userProfile.schedule[di].tasks[ti].done = !userProfile.schedule[di].tasks[ti].done;
  renderSchedule();
  saveProfile();
}

function updateStats() {
  const total = (userProfile.schedule||[]).reduce((a,d) => a + (d.tasks||[]).length, 0);
  const done  = (userProfile.schedule||[]).reduce((a,d) => a + (d.tasks||[]).filter(t=>t.done).length, 0);
  const pct   = total ? Math.round(done/total*100) : 0;
  document.getElementById('todayPct').textContent = pct + '%';
  document.getElementById('todayProg').style.width = pct + '%';
  document.getElementById('completedTasks').textContent = done;
  document.getElementById('totalHours').textContent = Math.round(done * 1.5);
  document.getElementById('streakNum').textContent = userProfile.streak || 0;
  document.getElementById('mizanStreak').textContent = userProfile.streak || 0;

  if(currentUser) {
    db.collection('users').orderBy('totalHours','desc').get().then(snap => {
      const rank = snap.docs.findIndex(d => d.id === currentUser.uid) + 1;
      document.getElementById('rankVal').textContent = rank || 'â€“';
    });
  }
}



// ===========================
// Group Study System
// ===========================
let sessionRunning = false;
let sessionSeconds = 0;
let sessionInterval = null;
let pomodoroRunning = false;
let pomodoroSeconds = 25 * 60;
let pomodoroPhase = 'focus';
let pomInterv = null;
let focusMode = false;
const POM_FOCUS = 25 * 60;
const POM_BREAK = 5 * 60;

const TOTAL_CIRC = 263.9;
let currentRoomId = null; // ID Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©

async function initGroupRoom() {
  if(!currentUser) return;
  
  const roomRef = db.collection('rooms').doc(currentUser.uid);
  const roomDoc = await roomRef.get();
  
  let code;
  if(!roomDoc.exists) {
    code = 'MAS-' + Math.random().toString(36).substring(2,6).toUpperCase();
    await roomRef.set({ 
      code, 
      owner: currentUser.uid, 
      members: {}, 
      createdAt: firebase.firestore.FieldValue.serverTimestamp() 
    });
  } else {
    code = roomDoc.data().code;
  }
  
  currentRoomId = currentUser.uid; // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ ØºØ±ÙØªÙ‡ Ù‡Ùˆ
  document.getElementById('myInviteCode').textContent = code;
  
  // ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³Ù‡ Ø¹Ø¶Ùˆ
  await roomRef.update({ 
    [`members.${currentUser.uid}`]: { 
      name: userProfile.name || 'Ù…Ø¬Ù‡ÙˆÙ„', 
      status: 'online' 
    } 
  });
  
  listenToRoom(currentUser.uid);
}

function syncSessionFromDB(data) {
  if(data.sessionTimer !== undefined) {
    const h = String(Math.floor(data.sessionTimer/3600)).padStart(2,'0');
    const m = String(Math.floor((data.sessionTimer%3600)/60)).padStart(2,'0');
    const s = String(data.sessionTimer%60).padStart(2,'0');
    document.getElementById('sessionTimer').textContent = `${h}:${m}:${s}`;
  }
  if(data.sessionRunning !== undefined) {
    const btn = document.getElementById('sessionBtn');
    btn.textContent = data.sessionRunning 
      ? 'â¸ ' + (currentLang==='ar'?'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª':'Pause')
      : t('group.startSession');
  }
}

function syncPomodoroFromDB(data) {
  if(data.pomSeconds !== undefined) {
    pomodoroSeconds = data.pomSeconds;
    pomodoroPhase = data.pomPhase || 'focus';
    updatePomUI();
    document.getElementById('pomLabel').textContent = t(pomodoroPhase==='focus'?'pom.focus':'pom.break');
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³ØªÙ‚Ù„Ø© Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
// ======= CHAT SYSTEM =======
function listenToRoom(roomId) {
  currentRoomId = roomId;

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØºØ±ÙØ© (Ø£Ø¹Ø¶Ø§Ø¡ + Ø¬Ù„Ø³Ø© + Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ)
  db.collection('rooms').doc(roomId).onSnapshot(snap => {
    if(!snap.exists) return;
    const data = snap.data();
    const members = data.members || {};
    document.getElementById('membersCount').textContent = 
      `${Object.keys(members).length} / 8`;
    renderMembersLive(members);
    syncSessionFromDB(data);
    syncPomodoroFromDB(data);
  });

  // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø§Øª - Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø´Ø±Ø·
  db.collection('rooms').doc(roomId)
    .collection('chat')
    .onSnapshot(snap => {
      console.log('chat snapshot:', snap.size); // Ù„Ù„ØªØ£ÙƒØ¯
      const msgs = [];
      snap.forEach(doc => msgs.push(doc.data()));
      msgs.sort((a,b) => (a.time?.seconds||0) - (b.time?.seconds||0));
      renderChatLive(msgs);
    }, err => {
      console.error('chat error:', err); // Ù„Ùˆ ÙÙŠÙ‡ Ø®Ø·Ø£ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§
    });
}

function renderChatLive(msgs) {
  const c = document.getElementById('groupChat');
  if(!msgs.length) {
    c.innerHTML = '<p style="text-align:center; color:var(--muted); font-size:12px; padding:20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p>';
    return;
  }
  c.innerHTML = msgs.map(m => `
    <div class="chat-msg">
      <div class="chat-avatar">${m.avatar || 'ØŸ'}</div>
      <div class="chat-bubble">
        <div class="chat-name">${m.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</div>
        ${m.msg || ''}
      </div>
    </div>
  `).join('');
  c.scrollTop = c.scrollHeight;
}

async function sendChat() {
  const inp = document.getElementById('chatInput');
  const msg = inp.value.trim();
  if(!msg || !currentUser) return;

  if(!currentRoomId) {
    showToast('âš ï¸ Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  const name = userProfile.name || 'Ù…Ø¬Ù‡ÙˆÙ„';
  inp.value = '';

  try {
    await db.collection('rooms').doc(currentRoomId)
      .collection('chat').add({
        name,
        msg,
        avatar: name[0] || 'ØŸ',
        uid: currentUser.uid,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    console.log('âœ… Ø±Ø³Ø§Ù„Ø© Ø£Ø±Ø³Ù„Øª Ø¨Ù†Ø¬Ø§Ø­');
  } catch(e) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', e);
    showToast('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + e.message);
  }
}

function groupTab(tab) {
  ['myRoom','joinRoom','leaderboard'].forEach(t => {
    const el = document.getElementById('groupTab' + t.charAt(0).toUpperCase() + t.slice(1));
    if(el) el.style.display = t===tab ? 'block':'none';
  });
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const map = { myRoom:'tabMyRoom', joinRoom:'tabJoinRoom', leaderboard:'tabLeader' };
  document.getElementById(map[tab])?.classList.add('active');
}

function copyCode() {
  const code = document.getElementById('myInviteCode').textContent;
  navigator.clipboard?.writeText(code).catch(()=>{});
  showToast('ğŸ“‹ ' + (currentLang==='ar'?'ØªÙ… Ø§Ù„Ù†Ø³Ø®':'Copied!'));
}

function shareRoom() {
  const code = document.getElementById('myInviteCode').textContent;
  if(navigator.share) navigator.share({ title:'Masar Study Room', text: code });
  else copyCode();
}

async function joinRoom() {
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if(!code) return showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯');
  
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØºØ±ÙØ©
  const snap = await db.collection('rooms').where('code', '==', code).limit(1).get();
  if(snap.empty) return showToast('âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
  
  const roomDoc = snap.docs[0];
  const roomId = roomDoc.id; // UID ØµØ§Ø­Ø¨ Ø§Ù„ØºØ±ÙØ©
  
  // Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ù‡ ÙƒØ¹Ø¶Ùˆ ÙÙŠ ØºØ±ÙØ© ØµØ§Ø­Ø¨Ù‡Ø§
  await roomDoc.ref.update({
    [`members.${currentUser.uid}`]: { 
      name: userProfile.name || 'Ø¶ÙŠÙ', 
      status: 'online' 
    }
  });
  
  showToast(`ğŸš€ Ø§Ù†Ø¶Ù…Ù…Øª Ø¥Ù„Ù‰ ${code}`);
  
  // Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØµÙŠØ± Ø¹Ù„Ù‰ ØºØ±ÙØ© ØµØ§Ø­Ø¨Ù‡Ø§ Ù…Ùˆ ØºØ±ÙØªÙ‡ Ù‡Ùˆ
  listenToRoom(roomId);
  
  groupTab('myRoom');
}

async function renderPublicRooms() {
  const snap = await db.collection('rooms').limit(5).get();
  const c = document.getElementById('publicRoomsList');
  if(snap.empty) { c.innerHTML = '<p style="color:var(--muted); text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ØªØ§Ø­Ø©</p>'; return; }
  
  c.innerHTML = snap.docs.map(d => {
    const r = d.data();
    const memberCount = Object.keys(r.members || {}).length;
    return `
      <div class="group-room" style="display:flex; align-items:center; gap:12px; padding:14px">
        <div style="flex:1">
          <strong>${r.code}</strong>
          <div style="font-size:11px; color:var(--muted); margin-top:3px">${memberCount} Ø£Ø¹Ø¶Ø§Ø¡</div>
        </div>
        <button class="btn-premium btn-purple" style="padding:7px 14px; font-size:12px" 
          onclick="document.getElementById('joinCode').value='${r.code}'; groupTab('joinRoom'); joinRoom()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
      </div>`;
  }).join('');
}
async function renderLeaderboard() {
  const snap = await db.collection('users').orderBy('totalHours', 'desc').limit(10).get();
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  
  document.getElementById('leaderboardList').innerHTML = snap.docs.map((d, i) => {
    const u = d.data();
    return `
      <div style="display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid var(--border)">
        <span style="font-size:1.3em; width:30px; text-align:center">${medals[i] || (i+1)}</span>
        <div style="flex:1">
          <strong>${u.name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</strong>
          <div style="font-size:11px; color:var(--muted)">${u.totalHours || 0}h Â· ğŸ”¥${u.streak || 0}</div>
        </div>
      </div>`;
  }).join('');
}

// Session Timer

function isRoomOwner() {
  return currentRoomId === currentUser.uid;
}

function toggleSession() {
  if(!isRoomOwner()) {
    showToast('â›” ' + (currentLang==='ar'?'ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„ØºØ±ÙØ© ÙŠØªØ­ÙƒÙ…':'Only owner can control'));
    return;
  }

  sessionRunning = !sessionRunning;

  if(sessionRunning) {
    // Ø­ÙØ¸ ÙÙŠ Firestore Ø¥Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¯Ø£Øª
    db.collection('rooms').doc(currentRoomId).update({ sessionRunning: true });
    
    sessionInterval = setInterval(() => {
      sessionSeconds++;
      // Ø­ÙØ¸ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Firestore ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
      db.collection('rooms').doc(currentRoomId).update({ 
        sessionTimer: sessionSeconds,
        sessionRunning: true
      });
    }, 1000);
    
    document.getElementById('sessionBtn').textContent = 'â¸ ' + (currentLang==='ar'?'Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª':'Pause');
  } else {
    clearInterval(sessionInterval);
    db.collection('rooms').doc(currentRoomId).update({ sessionRunning: false });
    document.getElementById('sessionBtn').textContent = t('group.startSession');
    userProfile.totalHours = (userProfile.totalHours||0) + Math.round(sessionSeconds/3600*10)/10;
    saveProfile();
  }
}

function togglePomodoro() {
  if(!isRoomOwner()) {
    showToast('â›” ' + (currentLang==='ar'?'ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„ØºØ±ÙØ© ÙŠØªØ­ÙƒÙ…':'Only owner can control'));
    return;
  }

  pomodoroRunning = !pomodoroRunning;

  if(pomodoroRunning) {
    document.getElementById('pomBtn').textContent = 'â¸ ' + (currentLang==='ar'?'Ø¥ÙŠÙ‚Ø§Ù':'Pause');
    
    pomInterv = setInterval(() => {
      pomodoroSeconds--;
      
      // Ø­ÙØ¸ ÙÙŠ Firestore ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
      db.collection('rooms').doc(currentRoomId).update({
        pomSeconds: pomodoroSeconds,
        pomPhase: pomodoroPhase,
        pomRunning: true
      });
      
      updatePomUI();
      
      if(pomodoroSeconds <= 0) {
        clearInterval(pomInterv);
        pomodoroRunning = false;
        pomodoroPhase = pomodoroPhase==='focus' ? 'break' : 'focus';
        pomodoroSeconds = pomodoroPhase==='focus' ? POM_FOCUS : POM_BREAK;
        
        db.collection('rooms').doc(currentRoomId).update({
          pomSeconds: pomodoroSeconds,
          pomPhase: pomodoroPhase,
          pomRunning: false
        });
        
        document.getElementById('pomLabel').textContent = t(pomodoroPhase==='focus'?'pom.focus':'pom.break');
        showToast(pomodoroPhase==='focus' ? 'ğŸ“š ØªØ±ÙƒÙŠØ²' : 'â˜• Ø§Ø³ØªØ±Ø§Ø­Ø©');
        updatePomUI();
      }
    }, 1000);
  } else {
    clearInterval(pomInterv);
    document.getElementById('pomBtn').textContent = t('pom.start');
    db.collection('rooms').doc(currentRoomId).update({ pomRunning: false });
  }
}
function endSession() {
  if(!isRoomOwner()) {
    showToast('â›” ' + (currentLang==='ar'?'ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„ØºØ±ÙØ© ÙŠØªØ­ÙƒÙ…':'Only owner can control'));
    return;
  }
  clearInterval(sessionInterval);
  sessionRunning = false;
  sessionSeconds = 0;
  
  db.collection('rooms').doc(currentRoomId).update({ 
    sessionTimer: 0, 
    sessionRunning: false 
  });
  
  showToast('ğŸ“Š ' + (currentLang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©':'Session saved'));
  userProfile.mizanGroups = (userProfile.mizanGroups||0) + 1;
  document.getElementById('mizanGroups').textContent = userProfile.mizanGroups;
  saveProfile();
}

function resetPomodoro() {
  if(!isRoomOwner()) {
    showToast('â›” ' + (currentLang==='ar'?'ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„ØºØ±ÙØ© ÙŠØªØ­ÙƒÙ…':'Only owner can control'));
    return;
  }
  clearInterval(pomInterv);
  pomodoroRunning = false;
  pomodoroPhase = 'focus';
  pomodoroSeconds = POM_FOCUS;
  
  db.collection('rooms').doc(currentRoomId).update({
    pomSeconds: POM_FOCUS,
    pomPhase: 'focus',
    pomRunning: false
  });
  
  document.getElementById('pomBtn').textContent = t('pom.start');
  document.getElementById('pomLabel').textContent = t('pom.focus');
  updatePomUI();
}
function updatePomUI() {
  const total = pomodoroPhase==='focus' ? POM_FOCUS : POM_BREAK;
  const mins = String(Math.floor(pomodoroSeconds/60)).padStart(2,'0');
  const secs = String(pomodoroSeconds%60).padStart(2,'0');
  document.getElementById('pomTime').textContent = `${mins}:${secs}`;
  const progress = pomodoroSeconds / total;
  const offset = TOTAL_CIRC * progress;
  document.getElementById('pomRing').style.strokeDashoffset = TOTAL_CIRC - offset;
}

// Focus Mode
function toggleFocusMode() {
  focusMode = !focusMode;
  const ball = document.getElementById('focusBall');
  const toggle = document.getElementById('focusToggle');
  if(focusMode) {
    ball.style.background = 'var(--gold)';
    toggle.style.background = 'rgba(212,175,55,0.2)';
    if(currentLang==='ar') ball.style.right = 'auto', ball.style.left = '2px';
    else ball.style.left = 'auto', ball.style.right = '2px';
    showToast('ğŸ”• ' + (currentLang==='ar'?'ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…ÙØ¹Ù‘Ù„':'Focus mode ON'));
  } else {
    ball.style.background = 'var(--muted)';
    toggle.style.background = 'rgba(255,255,255,0.1)';
    if(currentLang==='ar') ball.style.left = 'auto', ball.style.right = '2px';
    else ball.style.right = 'auto', ball.style.left = '2px';
    showToast('ğŸ”” ' + (currentLang==='ar'?'ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù…ØªÙˆÙ‚Ù':'Focus mode OFF'));
  }
}

// ===========================
// Arena
// ===========================
// Arena - Player Creates Questions
// ===========================
let arenaMatchId = null;
let arenaState = { qIndex:0, p1:0, p2:0, timer:null, qTimer:10, questions:[], isPlayer1: false };
 async function findArenaMatch() {
  showToast('ğŸ” ' + (currentLang==='ar'?'Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...':'Searching...'));
  
  try {
    document.getElementById('arenaLobby').style.display = 'none';
    document.getElementById('arenaGame').style.display = 'block';
    document.getElementById('player1Name').textContent = userProfile.name || 'Ø£Ù†Øª';
    document.getElementById('player2Name').textContent = 'â³';
    document.getElementById('qText').textContent = '';
    document.getElementById('qOptions').innerHTML = `
      <div style="text-align:center; padding:40px; color:var(--muted)">
        <i class="ri-loader-4-line" style="font-size:50px; color:var(--gold)"></i>
        <p style="margin-top:15px; font-size:1.1em">
          ${currentLang==='ar'?'Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...':'Searching...'}
        </p>
      </div>
    `;

const allMatches = await db.collection('matches')
  .orderBy('createdAt', 'desc')
  .limit(10)
  .get();

console.log('ÙƒÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª:', allMatches.size);

const twoMinsAgo = new Date(Date.now() - 2 * 60 * 1000);

const waitingMatch = allMatches.docs.find(d => {
  const data = d.data();
  const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0);
  return data.status === 'waiting' && 
         data.player1?.uid !== currentUser.uid &&
         createdAt >= twoMinsAgo;
});

console.log('Ù…Ø¨Ø§Ø±Ø§Ø© Ù…Ù†ØªØ¸Ø±Ø©:', waitingMatch ? waitingMatch.id : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯');
 
    
    if(waitingMatch) {
      console.log('âœ… ÙˆØ¬Ø¯Ù†Ø§ Ù…Ù†Ø§ÙØ³ Ø­Ù‚ÙŠÙ‚ÙŠ:', waitingMatch.id);
      arenaMatchId = waitingMatch.id;
      arenaState.isPlayer1 = false;

      await waitingMatch.ref.update({
        player2: { 
          uid: currentUser.uid, 
          name: userProfile.name || 'Ø¶ÙŠÙ', 
          score: 0 
        },
        status: 'asking'
      });

      document.getElementById('player1Name').textContent = waitingMatch.data().player1?.name || 'Ù…Ù†Ø§ÙØ³';
      document.getElementById('player2Name').textContent = userProfile.name || 'Ø£Ù†Øª';
      showWaitingForQuestion();
      showToast('âš”ï¸ ' + (currentLang==='ar'?'ÙˆØ¬Ø¯Ù†Ø§ Ù…Ù†Ø§ÙØ³!':'Found opponent!'));

    } else {
      console.log('â³ Ù†Ù†Ø´Ø¦ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©');
      arenaState.isPlayer1 = true;

      const matchRef = await db.collection('matches').add({
        player1: { 
          uid: currentUser.uid, 
          name: userProfile.name || 'Ù„Ø§Ø¹Ø¨', 
          score: 0 
        },
        player2: null,
        status: 'waiting',
        questions: [],
        currentQ: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      arenaMatchId = matchRef.id;
      showToast('â³ ' + (currentLang==='ar'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù†Ø§ÙØ³...':'Waiting...'));
      
      document.getElementById('qOptions').innerHTML = `
        <div style="text-align:center; padding:40px; color:var(--muted)">
          <i class="ri-time-line" style="font-size:50px; color:var(--gold)"></i>
          <p style="margin-top:15px; font-size:1.1em">
            ${currentLang==='ar'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ù†Ø§ÙØ³...':'Waiting for opponent...'}
          </p>
          <p style="font-size:0.8em; margin-top:8px; color:var(--gold)">
            ${currentLang==='ar'?'Ø§Ø·Ù„Ø¨ Ù…Ù† ØµØ¯ÙŠÙ‚Ùƒ ÙŠØ¶ØºØ· Ø§Ù„Ø¨Ø­Ø«':'Ask your friend to search'}
          </p>
        </div>
      `;
    }

    listenToMatch(arenaMatchId);

  } catch(e) {
    console.error('âŒ Ø®Ø·Ø£:', e);
    showToast('âŒ ' + e.message);
    document.getElementById('arenaLobby').style.display = 'block';
    document.getElementById('arenaGame').style.display = 'none';
  }
}

function listenToMatch(matchId) {
  db.collection('matches').doc(matchId).onSnapshot(snap => {
    if(!snap.exists) return;
    const data = snap.data();
    
    console.log('status:', data.status, '| isP1:', arenaState.isPlayer1);

    // Ù„Ø§Ø¹Ø¨ 1 - Ù„Ù…Ø§ ÙŠÙ†Ø¶Ù… Ù…Ù†Ø§ÙØ³ (ØªØºÙŠØ± Ù…Ù† waiting Ù„Ù€ asking)
    if(data.status === 'asking' && arenaState.isPlayer1) {
      document.getElementById('player2Name').textContent = data.player2?.name || 'Ù…Ù†Ø§ÙØ³';
      // ÙÙ‚Ø· Ø§Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ±Ù… Ù„Ùˆ Ù…Ùˆ Ø±Ø§Ù‡Ù† ÙŠÙƒØªØ¨ Ø³Ø¤Ø§Ù„
      const formExists = document.getElementById('arenaQ');
      if(!formExists) showQuestionForm();
    }
    
    // Ù„Ø§Ø¹Ø¨ 2 - Ù„Ù…Ø§ ÙŠØ±Ø³Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ Ø³Ø¤Ø§Ù„
    if(data.status === 'answering' && !arenaState.isPlayer1) {
      const q = data.questions?.[data.currentQ];
      if(q) showQuestionToAnswer(q, data.currentQ, data.questions.length);
    }
    
    // Ù„Ø§Ø¹Ø¨ 1 - Ø¨Ø¹Ø¯ Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠØŒ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
    if(data.status === 'asking' && arenaState.isPlayer1 && data.questions?.length > 0) {
      const formExists = document.getElementById('arenaQ');
      if(!formExists) showQuestionForm();
    }

    // Ù„Ø§Ø¹Ø¨ 2 - Ù„Ù…Ø§ ÙŠÙ†ØªØ¸Ø± Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
    if(data.status === 'asking' && !arenaState.isPlayer1) {
      const waiting = document.querySelector('.waiting-msg');
      if(!waiting) showWaitingForQuestion();
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    document.getElementById('player1Score').textContent = data.player1?.score || 0;
    document.getElementById('player2Score').textContent = data.player2?.score || 0;
    
    // Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©
    if(data.status === 'finished') endArenaLive(data);
  });
}

// Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙŠÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„
function showQuestionForm() {
  document.getElementById('qOptions').innerHTML = '';
  document.getElementById('qText').innerHTML = '';
  
  document.getElementById('qNum').textContent = (arenaState.qIndex + 1);
  document.getElementById('qTimer').textContent = 'â€“';
  
  document.getElementById('qText').innerHTML = `
    <div style="margin-bottom:12px; color:var(--gold); font-size:0.9em">
      ${currentLang==='ar'?'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ:':'Write your question:'}
    </div>
    <input type="text" id="arenaQ" class="field-input" 
      placeholder="${currentLang==='ar'?'Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§...':'Type your question...'}" 
      style="margin-bottom:10px">
    <input type="text" id="arenaOpt1" class="field-input" 
      placeholder="${currentLang==='ar'?'Ø§Ù„Ø®ÙŠØ§Ø± 1 (Ø§Ù„ØµØ­ÙŠØ­ âœ…)':'Option 1 (Correct âœ…)'}" 
      style="margin-bottom:8px; border-color:var(--teal)">
    <input type="text" id="arenaOpt2" class="field-input" 
      placeholder="${currentLang==='ar'?'Ø§Ù„Ø®ÙŠØ§Ø± 2':'Option 2'}" 
      style="margin-bottom:8px">
    <input type="text" id="arenaOpt3" class="field-input" 
      placeholder="${currentLang==='ar'?'Ø§Ù„Ø®ÙŠØ§Ø± 3':'Option 3'}" 
      style="margin-bottom:8px">
    <input type="text" id="arenaOpt4" class="field-input" 
      placeholder="${currentLang==='ar'?'Ø§Ù„Ø®ÙŠØ§Ø± 4':'Option 4'}" 
      style="margin-bottom:14px">
    <button class="btn-premium" style="width:100%" onclick="submitQuestion()">
      ${currentLang==='ar'?'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„':'ğŸ“¤ Send Question'}
    </button>
  `;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù€ Firestore
async function submitQuestion() {
  const q = document.getElementById('arenaQ')?.value.trim();
  const o1 = document.getElementById('arenaOpt1')?.value.trim();
  const o2 = document.getElementById('arenaOpt2')?.value.trim();
  const o3 = document.getElementById('arenaOpt3')?.value.trim();
  const o4 = document.getElementById('arenaOpt4')?.value.trim();
  
  if(!q || !o1 || !o2) {
    showToast('âš ï¸ ' + (currentLang==='ar'?'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„':'Enter question and 2 options'));
    return;
  }
  
  const opts = [o1, o2, o3, o4].filter(o => o);
  const newQ = { q, opts, ans: 0 }; // Ø§Ù„Ø¬ÙˆØ§Ø¨ Ø§Ù„ØµØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù‡Ùˆ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„
  
  const matchSnap = await db.collection('matches').doc(arenaMatchId).get();
  const questions = matchSnap.data().questions || [];
  questions.push(newQ);
  
  await db.collection('matches').doc(arenaMatchId).update({
    questions,
    currentQ: questions.length - 1,
    status: 'answering'
  });
  
  // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ø¬ÙˆØ§Ø¨
  document.getElementById('qText').innerHTML = '';
  document.getElementById('qOptions').innerHTML = `
    <div style="text-align:center; padding:30px; color:var(--muted)">
      <i class="ri-time-line" style="font-size:40px; color:var(--gold)"></i>
      <p style="margin-top:10px">${currentLang==='ar'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù…Ù†Ø§ÙØ³...':'Waiting for opponent answer...'}</p>
    </div>
  `;
  arenaState.qIndex++;
}

// Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ ÙŠØ´ÙˆÙ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆÙŠØ¬Ø§ÙˆØ¨
function showQuestionToAnswer(q, qIndex, total) {
  document.getElementById('qNum').textContent = qIndex + 1;
  document.getElementById('qText').textContent = q.q;
  
  // Ù…Ø¤Ù‚Øª
  arenaState.qTimer = 15;
  clearInterval(arenaState.timer);
  arenaState.timer = setInterval(() => {
    arenaState.qTimer--;
    document.getElementById('qTimer').textContent = arenaState.qTimer;
    if(arenaState.qTimer <= 0) {
      clearInterval(arenaState.timer);
      submitAnswer(-1, q.ans, qIndex, total); // Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª
    }
  }, 1000);
  
  document.getElementById('qOptions').innerHTML = q.opts.map((o,i) => `
    <div class="q-option" onclick="submitAnswer(${i}, ${q.ans}, ${qIndex}, ${total})">${o}</div>
  `).join('');
}

async function submitAnswer(chosen, correct, qIndex, total) {
  clearInterval(arenaState.timer);
  
  const opts = document.querySelectorAll('.q-option');
  if(opts[correct]) opts[correct].classList.add('correct');
  if(chosen !== correct && chosen >= 0 && opts[chosen]) opts[chosen].classList.add('wrong');
  
  const matchSnap = await db.collection('matches').doc(arenaMatchId).get();
  const data = matchSnap.data();
  let newScore = data.player2?.score || 0;
  if(chosen === correct) newScore++;
  
  // Ù‡Ù„ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŸ (5 Ø£Ø³Ø¦Ù„Ø© Ù…Ø«Ù„Ø§Ù‹)
  const isFinished = qIndex >= 4;
  
  await db.collection('matches').doc(arenaMatchId).update({
    'player2.score': newScore,
    status: isFinished ? 'finished' : 'asking'
  });
  
  if(!isFinished) {
    setTimeout(() => {
      document.getElementById('qOptions').innerHTML = `
        <div style="text-align:center; padding:30px; color:var(--muted)">
          <i class="ri-pencil-line" style="font-size:40px; color:var(--gold)"></i>
          <p style="margin-top:10px">${currentLang==='ar'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯...':'Waiting for next question...'}</p>
        </div>
      `;
      document.getElementById('qText').textContent = '';
    }, 1000);
  }
}
function showWaitingForQuestion() {
  document.getElementById('qText').textContent = '';
  document.getElementById('qOptions').innerHTML = `
    <div class="waiting-msg" style="text-align:center; padding:30px; color:var(--muted)">
      <i class="ri-pencil-line" style="font-size:40px; color:var(--gold)"></i>
      <p style="margin-top:10px">
        ${currentLang==='ar'?'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù†Ø§ÙØ³...':'Waiting for opponent question...'}
      </p>
    </div>
  `;
}

async function endArenaLive(data) {
  const isP1 = data.player1?.uid === currentUser.uid;
  const myScore = isP1 ? data.player1?.score : data.player2?.score;
  const oppScore = isP1 ? data.player2?.score : data.player1?.score;
  const won = myScore > oppScore;
  
  if(won) {
    userProfile.arenaWins = (userProfile.arenaWins||0) + 1;
    document.getElementById('arenaWins').textContent = userProfile.arenaWins;
    saveProfile();
  }
  
  showToast(won 
    ? 'ğŸ† '+(currentLang==='ar'?'Ø§Ù†ØªØµØ±Øª!':'You won!') 
    : myScore === oppScore 
      ? 'ğŸ¤ '+(currentLang==='ar'?'ØªØ¹Ø§Ø¯Ù„!':'Draw!')
      : 'ğŸ˜¤ '+(currentLang==='ar'?'Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!':'Better luck!'));
  
  setTimeout(() => {
    document.getElementById('arenaGame').style.display = 'none';
    document.getElementById('arenaLobby').style.display = 'block';
    arenaMatchId = null;
  }, 3000);
}

// Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙØ±Ø¯ÙŠ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¶Ø¯ AI)
async function startSoloChallenge() {
  arenaState.questions = arenaQuestions[currentLang] || arenaQuestions['ar'];
  arenaState.qIndex = 0;
  arenaState.p1 = 0;
  arenaState.p2 = 0;
  arenaState.isPlayer1 = true;
  arenaMatchId = null;
  
  document.getElementById('arenaLobby').style.display = 'none';
  document.getElementById('arenaGame').style.display = 'block';
  document.getElementById('player1Name').textContent = userProfile.name || 'Ø£Ù†Øª';
  document.getElementById('player2Name').textContent = 'ğŸ¤– AI';
  
  loadArenaQuestionSolo();
}

function loadArenaQuestionSolo() {
  const qs = arenaState.questions;
  if(arenaState.qIndex >= qs.length) {
    const won = arenaState.p1 >= arenaState.p2;
    if(won) { userProfile.arenaWins = (userProfile.arenaWins||0)+1; saveProfile(); }
    showToast(won ? 'ğŸ† Ø§Ù†ØªØµØ±Øª!' : 'ğŸ˜¤ Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!');
    document.getElementById('arenaGame').style.display = 'none';
    document.getElementById('arenaLobby').style.display = 'block';
    return;
  }
  const q = qs[arenaState.qIndex];
  document.getElementById('qNum').textContent = arenaState.qIndex + 1;
  document.getElementById('qText').textContent = q.q;
  document.getElementById('qOptions').innerHTML = q.opts.map((o,i) => `
    <div class="q-option" onclick="answerSolo(${i},${q.ans})">${o}</div>
  `).join('');
  arenaState.qTimer = 10;
  clearInterval(arenaState.timer);
  arenaState.timer = setInterval(() => {
    arenaState.qTimer--;
    document.getElementById('qTimer').textContent = arenaState.qTimer;
    if(arenaState.qTimer <= 0) {
      clearInterval(arenaState.timer);
      arenaState.p2++;
      document.getElementById('player2Score').textContent = arenaState.p2;
      setTimeout(() => { arenaState.qIndex++; loadArenaQuestionSolo(); }, 800);
    }
  }, 1000);
}

function answerSolo(chosen, correct) {
  clearInterval(arenaState.timer);
  const opts = document.querySelectorAll('.q-option');
  opts[correct].classList.add('correct');
  if(chosen !== correct) {
    opts[chosen].classList.add('wrong');
    arenaState.p2++;
    document.getElementById('player2Score').textContent = arenaState.p2;
  } else {
    arenaState.p1++;
    document.getElementById('player1Score').textContent = arenaState.p1;
  }
  setTimeout(() => { arenaState.qIndex++; loadArenaQuestionSolo(); }, 1000);
}

// ===========================
// Navigation & Utilities
// ===========================
function goPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page===pageId));
  window.scrollTo(0,0);
  if(pageId==='pageGroup') document.getElementById('groupNotif').style.display='none';
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// Init
updatePomUI();
</script></body>
</html>
