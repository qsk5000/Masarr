<!DOCTYPE html>

<html lang="ar" dir="rtl" data-lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Masar V3 | Ù…Ø³Ø§Ø±</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&family=Noto+Kufi+Arabic:wght@400;700;900&family=Space+Mono:wght@400;700&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#D4AF37;--gold-dark:#AA8A2E;--gold-glow:rgba(212,175,55,0.3);
  --ink:#0A0C10;--surface:#0F1117;--card:#161B22;
  --border:rgba(255,255,255,0.08);--text:#E6EDF3;--muted:#8B949E;
  --teal:#238636;--rose:#DA3633;--purple:#7C3AED;--blue:#1D4ED8;
  --font-ar:'IBM Plex Sans Arabic',sans-serif;
  --font-en:'Plus Jakarta Sans',sans-serif;
  --font-mono:'Space Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html[data-lang="en"]{direction:ltr}
html[data-lang="ar"]{direction:rtl}
html[data-lang="en"] body{font-family:var(--font-en)}
html[data-lang="ar"] body{font-family:var(--font-ar)}
body{background:var(--ink);color:var(--text);line-height:1.6;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 50% -20%,#1e2631 0%,var(--ink) 70%);z-index:-1}

/* â€“â€“ LANG BAR â€“â€“ */
#langBar{position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:6px;background:rgba(22,27,34,0.95);border:1px solid var(â€“border);border-radius:20px;padding:5px 8px;backdrop-filter:blur(10px)}
html[data-lang=â€œenâ€] #langBar{left:15px;right:auto}
.lang-btn{padding:4px 12px;border-radius:14px;font-size:11px;font-weight:700;cursor:pointer;border:none;background:transparent;color:var(â€“muted);transition:.2s}
.lang-btn.active{background:var(â€“gold);color:var(â€“ink)}

/* â€“â€“ CARDS â€“â€“ */
.glass-card{background:var(â€“card);border:1px solid var(â€“border);border-radius:20px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,.2);transition:transform .3s cubic-bezier(.175,.885,.32,1.275),border-color .3s}
.glass-card:hover{transform:translateY(-4px);border-color:var(â€“gold)}

/* â€“â€“ NAV â€“â€“ */
#bottomNav{position:fixed;bottom:20px;left:20px;right:20px;height:65px;background:rgba(22,27,34,0.95);backdrop-filter:blur(15px);border:1px solid var(â€“border);border-radius:25px;display:flex;justify-content:space-around;align-items:center;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,.5)}
.nav-item{position:relative;color:var(â€“muted);cursor:pointer;transition:all .3s;display:flex;flex-direction:column;align-items:center}
.nav-item.active{color:var(â€“gold);transform:translateY(-5px)}
.nav-item i{font-size:24px}
.nav-item span{font-size:10px;font-weight:600;margin-top:2px}

/* â€“â€“ PAGES â€“â€“ */
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.page{display:none;padding:20px 20px 100px;animation:slideUp .4s ease forwards}
.page.active{display:block}

/* â€“â€“ AUTH â€“â€“ */
#authOverlay{position:fixed;inset:0;background:var(â€“ink);z-index:10001;display:flex;align-items:center;justify-content:center}
.auth-card{width:90%;max-width:420px;text-align:center;background:var(â€“card);border:1px solid var(â€“border);border-radius:24px;padding:35px 30px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.auth-input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(â€“border);background:#1c2128;color:white;font-size:.95em;margin-bottom:10px;outline:none;transition:border .2s}
html[data-lang=â€œarâ€] .auth-input{font-family:var(â€“font-ar);text-align:right}
html[data-lang=â€œenâ€] .auth-input{font-family:var(â€“font-en);text-align:left}
.auth-input:focus{border-color:var(â€“gold)}

/* â€“â€“ BUTTONS â€“â€“ */
.mizan-badge{background:linear-gradient(45deg,var(â€“gold),#f3d16e);color:var(â€“ink);padding:2px 8px;border-radius:5px;font-size:10px;font-weight:900;vertical-align:middle}
.btn-premium{background:linear-gradient(45deg,var(â€“gold),var(â€“gold-dark));color:var(â€“ink);border:none;padding:13px 25px;border-radius:14px;font-weight:900;cursor:pointer;box-shadow:0 4px 15px var(â€“gold-glow);transition:.3s;font-size:.95em}
html[data-lang=â€œarâ€] .btn-premium{font-family:var(â€“font-ar)}
html[data-lang=â€œenâ€] .btn-premium{font-family:var(â€“font-en)}
.btn-premium:active{transform:scale(.95)}
.btn-green{background:linear-gradient(45deg,#238636,#1a6326);color:white;box-shadow:none}
.btn-purple{background:linear-gradient(45deg,#7C3AED,#5B21B6);color:white;box-shadow:0 4px 15px rgba(124,58,237,.3)}
.btn-red{background:linear-gradient(45deg,#DA3633,#9b1e1c);color:white;box-shadow:none}

/* â€“â€“ INPUTS â€“â€“ */
.field-input{width:100%;padding:12px 14px;border-radius:11px;background:#0A0C10;border:1px solid var(â€“border);color:white;outline:none;transition:border .2s}
html[data-lang=â€œarâ€] .field-input{font-family:var(â€“font-ar);text-align:right}
html[data-lang=â€œenâ€] .field-input{font-family:var(â€“font-en);text-align:left}
.field-input:focus{border-color:var(â€“gold)}
.field-label{display:block;margin-bottom:6px;font-size:.85em;color:var(â€“muted)}

/* â€“â€“ TASK ITEMS â€“â€“ */
.task-item{display:flex;align-items:center;gap:12px;padding:13px;background:rgba(255,255,255,.03);border-radius:13px;border-inline-end:4px solid var(â€“gold);margin-bottom:10px}
.task-time{font-family:var(â€“font-mono);color:var(â€“gold);font-weight:bold;font-size:.85em;white-space:nowrap}

/* â€“â€“ TOAST â€“â€“ */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(â€“gold);color:var(â€“ink);padding:12px 25px;border-radius:12px;font-weight:bold;z-index:99999;opacity:0;pointer-events:none;transition:.3s;white-space:nowrap;max-width:90vw}
#toast.show{opacity:1;top:40px}

.schedule-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:15px}

/* â€“â€“ GROUP SYSTEM â€“â€“ */
.group-room{border:1px solid var(â€“border);border-radius:16px;padding:18px;margin-bottom:14px;background:rgba(255,255,255,.02);transition:border-color .3s,transform .3s}
.group-room:hover{border-color:var(â€“purple);transform:translateY(-3px)}
.group-room-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.group-tag{font-size:10px;font-weight:700;padding:3px 9px;border-radius:8px;background:rgba(124,58,237,.2);color:#a78bfa;border:1px solid rgba(124,58,237,.3)}
.members-row{display:flex;flex-wrap:wrap;gap:7px;margin:10px 0}
.member-chip{display:flex;align-items:center;gap:5px;padding:4px 10px;background:rgba(255,255,255,.05);border-radius:20px;font-size:12px}
.member-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;flex-shrink:0}
.member-dot.away{background:#f59e0b}
.member-dot.offline{background:var(â€“muted)}
.session-timer{font-family:var(â€“font-mono);font-size:1.6em;color:var(â€“gold);text-align:center;padding:12px;background:rgba(212,175,55,.05);border-radius:12px;border:1px solid rgba(212,175,55,.15);margin:12px 0;letter-spacing:3px}
.focus-mode-bar{display:flex;align-items:center;gap:8px;padding:10px 14px;background:rgba(124,58,237,.1);border-radius:11px;border:1px solid rgba(124,58,237,.2);margin-top:10px;cursor:pointer}
.focus-mode-bar i{color:#a78bfa}

/* â€“â€“ CHAT â€“â€“ */
.group-chat{max-height:220px;overflow-y:auto;margin:10px 0;padding:0 2px}
.group-chat::-webkit-scrollbar{width:3px}
.group-chat::-webkit-scrollbar-thumb{background:var(â€“border);border-radius:3px}
.chat-msg{display:flex;gap:8px;margin-bottom:10px;align-items:flex-start;animation:slideUp .3s ease}
html[data-lang=â€œenâ€] .chat-msg{flex-direction:row}
html[data-lang=â€œarâ€] .chat-msg{flex-direction:row-reverse}
.chat-msg.own-msg .chat-bubble{background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.2)}
.chat-avatar{width:30px;height:30px;border-radius:50%;flex-shrink:0;background:linear-gradient(45deg,var(â€“purple),var(â€“gold));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white}
.chat-bubble{background:rgba(255,255,255,.05);border-radius:10px;padding:8px 12px;font-size:.83em;max-width:80%}
html[data-lang=â€œarâ€] .chat-bubble{border-radius:10px 2px 10px 10px;text-align:right}
html[data-lang=â€œenâ€] .chat-bubble{border-radius:2px 10px 10px 10px;text-align:left}
.chat-name{font-size:10px;color:var(â€“muted);margin-bottom:3px;font-weight:600}
.chat-time{font-size:9px;color:rgba(139,148,158,.5);margin-top:3px}
.chat-input-row{display:flex;gap:8px;margin-top:10px}
.chat-input-row input{flex:1;padding:10px 14px;border-radius:10px;border:1px solid var(â€“border);background:#0A0C10;color:white;font-size:.85em;outline:none}
html[data-lang=â€œarâ€] .chat-input-row input{text-align:right;font-family:var(â€“font-ar)}
html[data-lang=â€œenâ€] .chat-input-row input{text-align:left;font-family:var(â€“font-en)}
.chat-input-row input:focus{border-color:var(â€“gold)}
.chat-input-row button{width:40px;height:40px;border-radius:10px;border:none;background:var(â€“purple);color:white;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:.2s}
.chat-input-row button:active{transform:scale(.9)}

/* â€“â€“ POMODORO â€“â€“ */
.pomodoro-ring{position:relative;width:110px;height:110px;margin:0 auto}
.pomodoro-ring svg{transform:rotate(-90deg)}
.pomodoro-ring circle{fill:none;stroke-width:6}
.ring-bg{stroke:rgba(255,255,255,.07)}
.ring-progress{stroke:var(â€“gold);stroke-linecap:round;transition:stroke-dashoffset 1s linear}
.ring-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.ring-text span{font-family:var(â€“font-mono);font-size:1.1em;font-weight:700}
.ring-text small{font-size:9px;color:var(â€“muted)}

/* â€“â€“ STREAK â€“â€“ */
.streak-flame{font-size:2em}
@keyframes flicker{0%,100%{transform:scale(1) rotate(-2deg)}50%{transform:scale(1.1) rotate(2deg)}}
.streak-flame{animation:flicker 1.5s ease-in-out infinite;display:inline-block}

/* â€“â€“ STATS â€“â€“ */
.stat-mini{text-align:center;padding:16px 12px;background:rgba(255,255,255,.02);border-radius:14px;border:1px solid var(â€“border)}
.stat-mini .num{font-size:1.8em;font-weight:900;font-family:var(â€“font-mono);color:var(â€“gold)}
.stat-mini .lbl{font-size:11px;color:var(â€“muted);margin-top:4px}
.prog-bar{background:rgba(255,255,255,.06);border-radius:99px;height:6px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(â€“gold),#f3d16e);transition:width .8s ease}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.section-title{font-size:1.1em;font-weight:700}
html[data-lang=â€œarâ€] .section-title{font-family:â€˜Noto Kufi Arabicâ€™}

/* â€“â€“ TABS â€“â€“ */
.tabs{display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px}
.tab-btn{padding:7px 16px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(â€“border);background:transparent;color:var(â€“muted);white-space:nowrap;transition:.2s}
.tab-btn.active{background:var(â€“gold);color:var(â€“ink);border-color:var(â€“gold)}

/* â€“â€“ INVITE CODE â€“â€“ */
.invite-code{font-family:var(â€“font-mono);font-size:1.4em;font-weight:700;color:var(â€“gold);letter-spacing:5px;text-align:center;padding:14px;background:rgba(212,175,55,.05);border:1px dashed rgba(212,175,55,.3);border-radius:12px;cursor:pointer;user-select:all}

/* â€“â€“ NOTIF DOT â€“â€“ */
.notif-dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:var(â€“rose);border-radius:50%;border:2px solid var(â€“ink)}
html[data-lang=â€œenâ€] .notif-dot{left:-2px;right:auto}

/* â€“â€“ ARENA â€“â€“ */
.arena-vs{display:grid;grid-template-columns:1fr auto 1fr;gap:15px;align-items:center;margin-bottom:20px}
.arena-player{text-align:center;padding:15px;background:rgba(255,255,255,.03);border-radius:14px}
.arena-vs-badge{font-family:var(â€“font-mono);font-size:1.3em;font-weight:700;color:var(â€“rose);background:rgba(218,54,51,.1);border-radius:12px;padding:10px 8px;border:1px solid rgba(218,54,51,.2)}
.q-option{padding:13px 16px;border-radius:12px;border:1px solid var(â€“border);cursor:pointer;margin-bottom:8px;transition:.2s;background:rgba(255,255,255,.02);user-select:none}
.q-option:hover{border-color:var(â€“gold);background:rgba(212,175,55,.05)}
.q-option.correct{border-color:var(â€“teal);background:rgba(35,134,54,.1)}
.q-option.wrong{border-color:var(â€“rose);background:rgba(218,54,51,.1)}

/* â€“â€“ MATCHMAKING LOADING â€“â€“ */
.matchmaking-pulse{text-align:center;padding:40px 20px}
.pulse-ring{width:80px;height:80px;border-radius:50%;border:3px solid var(â€“gold);margin:0 auto 20px;position:relative;animation:pulseRing 1.5s ease-in-out infinite}
@keyframes pulseRing{0%{box-shadow:0 0 0 0 rgba(212,175,55,.4)}70%{box-shadow:0 0 0 20px rgba(212,175,55,0)}100%{box-shadow:0 0 0 0 rgba(212,175,55,0)}}

/* â€“â€“ ONLINE INDICATOR â€“â€“ */
.online-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 8px;border-radius:20px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);font-size:10px;color:#22c55e}
.online-dot-anim{width:6px;height:6px;border-radius:50%;background:#22c55e;animation:blink 1.5s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* â€“â€“ ROOM CARD â€“â€“ */
.room-card{padding:14px;border:1px solid var(â€“border);border-radius:14px;margin-bottom:10px;cursor:pointer;transition:.2s;background:rgba(255,255,255,.02)}
.room-card:hover{border-color:var(â€“purple);background:rgba(124,58,237,.05)}
.room-card.active-room{border-color:var(â€“teal);background:rgba(35,134,54,.05)}

/* â€“â€“ WAITING SCREEN â€“â€“ */
.waiting-screen{text-align:center;padding:30px;background:rgba(255,255,255,.02);border-radius:16px;border:1px solid var(â€“border)}
.waiting-screen i{font-size:48px;color:var(â€“muted);margin-bottom:10px;display:block}

/* â€“â€“ SYSTEM MSG â€“â€“ */
.system-msg{text-align:center;font-size:11px;color:var(â€“muted);margin:8px 0;padding:4px 10px;background:rgba(255,255,255,.03);border-radius:20px}
</style>

</head>
<body>

<div id="langBar">
  <button class="lang-btn active" onclick="setLang('ar')">Ø¹Ø±Ø¨ÙŠ</button>
  <button class="lang-btn" onclick="setLang('en')">EN</button>
</div>
<div id="toast"></div>

<!-- ======= AUTH OVERLAY ======= -->

<div id="authOverlay">
  <div class="auth-card">
    <div style="font-size:2.8em;font-family:'Noto Kufi Arabic';font-weight:900;margin-bottom:4px" id="authLogoText">Ù…Ù€Ø³Ù€Ø§Ø± <span class="mizan-badge">V3</span></div>
    <p style="color:var(--muted);margin-bottom:24px;font-size:.9em" id="authSubtitle">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</p>
    <input class="auth-input" type="email" id="userEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input class="auth-input" type="password" id="userPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <p style="text-align:left;font-size:.75em;color:var(--gold);cursor:pointer;margin:-4px 5px 14px" onclick="forgotPassword()" id="forgotPassText">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</p>
    <button class="btn-premium" style="width:100%;font-size:1em" onclick="handleAuth()" id="authLoginBtn">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©</button>
    <button class="btn-premium" style="width:100%;margin-top:10px;background:white;color:#444;display:flex;align-items:center;justify-content:center;gap:10px" onclick="loginWithGoogle()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
      <span id="googleBtnText">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¬ÙˆØ¬Ù„</span>
    </button>
    <p style="margin-top:14px;font-size:.8em;color:var(--muted);cursor:pointer" onclick="toggleAuthMode()" id="authSignupLink">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</p>
  </div>
</div>

<!-- ======= BOTTOM NAV ======= -->

<nav id="bottomNav" style="display:none">
  <div class="nav-item active" onclick="goPage('pageSetup')" data-page="pageSetup">
    <i class="ri-settings-4-fill"></i><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</span>
  </div>
  <div class="nav-item" onclick="goPage('pageSchedule')" data-page="pageSchedule">
    <i class="ri-calendar-event-fill"></i><span>Ø§Ù„Ø¬Ø¯ÙˆÙ„</span>
  </div>
  <div class="nav-item" onclick="goPage('pageGroup')" data-page="pageGroup">
    <i class="ri-team-fill"></i><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
    <div class="notif-dot" id="groupNotif" style="display:none"></div>
  </div>
  <div class="nav-item" onclick="goPage('pageArena')" data-page="pageArena">
    <i class="ri-sword-fill"></i><span>Ø§Ù„ØªØ­Ø¯ÙŠ</span>
    <div class="notif-dot" id="arenaNotif" style="display:none"></div>
  </div>
  <div class="nav-item" onclick="goPage('pageMizan')" data-page="pageMizan">
    <i class="ri-shield-check-fill"></i><span>Ø§Ù„Ù…ÙŠØ²Ø§Ù†</span>
  </div>
</nav>

<!-- ======= PAGE: SETUP ======= -->

<div id="pageSetup" class="page active">
  <h2 style="font-family:'Noto Kufi Arabic';margin-bottom:20px">ØªØ®ØµÙŠØµ Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø°ÙƒÙŠØ© ğŸ§ </h2>
  <div class="glass-card" style="margin-bottom:20px">
    <div style="margin-bottom:14px">
      <label class="field-label">Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„</label>
      <input type="text" id="studentName" class="field-input" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§...">
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
      <div>
        <label class="field-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
        <select id="studyLevel" class="field-input">
          <option value="6">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
          <option value="3">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
          <option value="univ">Ø¬Ø§Ù…Ø¹Ø©</option>
          <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div>
        <label class="field-label">ÙˆÙ‚Øª Ø°Ø±ÙˆØ© Ø§Ù„Ù†Ø´Ø§Ø·</label>
        <select id="peakTime" class="field-input">
          <option value="morning">ØµØ¨Ø§Ø­Ø§Ù‹ / ÙØ¬Ø±Ø§Ù‹</option>
          <option value="evening">Ù…Ø³Ø§Ø¡Ù‹</option>
        </select>
      </div>
    </div>
    <button class="btn-premium" style="width:100%" onclick="saveProfile()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </div>
  <div class="section-header">
    <span class="section-title">ğŸ“š Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</span>
  </div>
  <div class="glass-card" style="border-style:dashed;margin-bottom:14px">
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:10px;margin-bottom:10px">
      <input type="text" id="subjName" class="field-input" placeholder="ÙƒÙŠÙ…ÙŠØ§Ø¡ØŒ ÙÙŠØ²ÙŠØ§Ø¡...">
      <select id="subjDiff" class="field-input">
        <option value="3">ØµØ¹Ø¨Ø©</option>
        <option value="2">Ù…ØªÙˆØ³Ø·Ø©</option>
        <option value="1">Ø³Ù‡Ù„Ø©</option>
      </select>
    </div>
    <button class="btn-premium btn-green" style="width:100%" onclick="addSubject()">ï¼‹ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³Ø§Ø±</button>
  </div>
  <div id="subjectsList"></div>
  <button class="btn-premium" style="width:100%;margin-top:25px;font-size:1.1em" onclick="generateAISchedule()">âœ¨ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
</div>

<!-- ======= PAGE: SCHEDULE ======= -->

<div id="pageSchedule" class="page">
  <div class="glass-card" style="background:linear-gradient(135deg,#161B22 0%,#0A0C10 100%);margin-bottom:20px">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div>
        <h2 id="welcomeMsg" style="color:var(--gold);font-family:'Noto Kufi Arabic'">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„Ùƒ...</h2>
        <p id="progressStat" style="color:var(--muted);font-size:.85em">Ø£Ù†Ø¬Ø² Ù…Ù‡Ø§Ù…Ùƒ Ù„ØªØ±ÙØ¹ Ù…Ø³ØªÙˆØ§Ùƒ</p>
      </div>
      <div style="text-align:center">
        <div class="streak-flame">ğŸ”¥</div>
        <div style="font-family:var(--font-mono);font-size:1.4em;font-weight:700" id="streakNum">0</div>
        <div style="font-size:10px;color:var(--muted)">ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„</div>
      </div>
    </div>
    <div style="margin-top:14px">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px">
        <span>Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</span><span id="todayPct">0%</span>
      </div>
      <div class="prog-bar"><div class="prog-fill" id="todayProg" style="width:0%"></div></div>
    </div>
  </div>
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px">
    <div class="stat-mini"><div class="num" id="totalHours">0</div><div class="lbl">Ø³Ø§Ø¹Ø© Ø¯Ø±Ø§Ø³Ø©</div></div>
    <div class="stat-mini"><div class="num" id="completedTasks">0</div><div class="lbl">Ù…Ù‡Ù…Ø© Ù…Ù†Ø¬Ø²Ø©</div></div>
    <div class="stat-mini"><div class="num" id="rankVal">â€“</div><div class="lbl">Ø§Ù„ØªØ±ØªÙŠØ¨</div></div>
  </div>
  <div id="scheduleContainer" class="schedule-grid"></div>
</div>

<!-- ======= PAGE: GROUP STUDY (REAL) ======= -->

<div id="pageGroup" class="page">
  <div style="margin-bottom:20px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h2 style="font-family:'Noto Kufi Arabic'">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h2>
      <div class="online-badge" id="onlineCountBadge">
        <div class="online-dot-anim"></div>
        <span id="onlineCount">0</span> Ù…ØªØµÙ„
      </div>
    </div>
    <p style="color:var(--muted);font-size:.85em;margin-top:5px">ØºØ±Ù Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ø¹ Ø·Ù„Ø§Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ†</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="groupTab('myRoom')" id="tabMyRoom">ØºØ±ÙØªÙŠ</button>
    <button class="tab-btn" onclick="groupTab('browse')" id="tabBrowse">ØªØµÙØ­ Ø§Ù„ØºØ±Ù</button>
    <button class="tab-btn" onclick="groupTab('join')" id="tabJoin">Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨ÙƒÙˆØ¯</button>
    <button class="tab-btn" onclick="groupTab('leader')" id="tabLeader">Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ†</button>
  </div>

  <!-- MY ROOM -->

  <div id="groupTabMyRoom">
    <!-- Create Room (shown if no active room) -->
    <div id="createRoomSection">
      <div class="glass-card" style="text-align:center;padding:30px;margin-bottom:15px">
        <i class="ri-home-8-line" style="font-size:50px;color:var(--gold);margin-bottom:10px;display:block"></i>
        <h3 style="margin-bottom:8px">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØªÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h3>
        <p style="color:var(--muted);font-size:.85em;margin-bottom:20px">Ø£Ù†Ø´Ø¦ ØºØ±ÙØ© ÙˆØ§Ø¯Ø¹Ù Ø²Ù…Ù„Ø§Ø¦Ùƒ Ù„Ù„Ø¯Ø±Ø§Ø³Ø© Ù…Ø¹Ùƒ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</p>
        <input type="text" id="roomNameInput" class="field-input" style="margin-bottom:12px;text-align:center" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: ØºØ±ÙØ© Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡)">
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <select id="roomSubjectSelect" class="field-input">
            <option value="">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</option>
            <option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
            <option>Ø£Ø­ÙŠØ§Ø¡</option><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option><option>Ø£Ø®Ø±Ù‰</option>
          </select>
          <select id="roomPrivacy" class="field-input" style="width:130px">
            <option value="public">Ø¹Ø§Ù…Ø© ğŸŒ</option>
            <option value="private">Ø®Ø§ØµØ© ğŸ”’</option>
          </select>
        </div>
        <button class="btn-premium" style="width:100%" onclick="createRoom()">ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
      </div>
    </div>

```
<!-- Active Room (shown when in a room) -->
<div id="activeRoomSection" style="display:none">
  <div class="glass-card" style="margin-bottom:15px">
    <div class="group-room-header">
      <div>
        <strong id="activeRoomName" style="font-size:1.1em">ØºØ±ÙØªÙŠ</strong>
        <div class="group-tag" style="display:inline-block;margin-inline-start:8px" id="activeRoomStatus">ğŸ”´ Ù…Ø¨Ø§Ø´Ø±</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <i class="ri-share-line" style="color:var(--gold);cursor:pointer;font-size:20px" onclick="shareRoom()"></i>
        <i class="ri-door-open-line" style="color:var(--rose);cursor:pointer;font-size:20px" onclick="leaveRoom()"></i>
      </div>
    </div>

    <div class="invite-code" id="myInviteCode" onclick="copyCode()">MAS-XXXX</div>
    <p style="text-align:center;font-size:11px;color:var(--muted);margin-top:6px">Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>

    <!-- Session Timer -->
    <div class="session-timer" id="sessionTimer">00:00:00</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn-premium" onclick="toggleSession()" id="sessionBtn">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button class="btn-premium btn-red" style="box-shadow:none" onclick="endSession()">â¬› Ø¥Ù†Ù‡Ø§Ø¡</button>
    </div>

    <!-- Pomodoro -->
    <div style="margin-top:18px;padding-top:15px;border-top:1px solid var(--border)">
      <div style="text-align:center;margin-bottom:12px;font-size:.85em;font-weight:600">â± Ù…Ø¤Ù‚Øª Ø¨ÙˆÙ…ÙˆØ¯ÙˆØ±Ùˆ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ</div>
      <div class="pomodoro-ring">
        <svg width="110" height="110" viewBox="0 0 110 110">
          <circle class="ring-bg" cx="55" cy="55" r="47"/>
          <circle class="ring-progress" cx="55" cy="55" r="47" id="pomRing" stroke-dasharray="295.3" stroke-dashoffset="0"/>
        </svg>
        <div class="ring-text">
          <span id="pomTime">25:00</span>
          <small id="pomLabel">ØªØ±ÙƒÙŠØ²</small>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
        <button class="btn-premium" style="padding:8px 18px;font-size:.85em" onclick="togglePomodoro()" id="pomBtn">Ø¨Ø¯Ø¡</button>
        <button class="btn-premium" style="padding:8px 18px;font-size:.85em;background:rgba(255,255,255,.06);color:var(--text);box-shadow:none" onclick="resetPomodoro()">Ø¥Ø¹Ø§Ø¯Ø©</button>
      </div>
    </div>
  </div>

  <!-- REAL Members List -->
  <div class="glass-card" style="margin-bottom:15px">
    <div class="section-header">
      <span class="section-title">ğŸ‘¥ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„ØºØ±ÙØ©</span>
      <span style="font-size:12px;color:var(--muted)" id="membersCount">0 / 20</span>
    </div>
    <div class="members-row" id="membersList">
      <div style="color:var(--muted);font-size:.85em">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯...</div>
    </div>
  </div>

  <!-- REAL Group Chat -->
  <div class="glass-card">
    <div class="section-header">
      <span class="section-title">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</span>
      <i class="ri-message-3-line" style="color:var(--muted)"></i>
    </div>
    <div class="group-chat" id="groupChat">
      <div class="waiting-screen" style="padding:20px">
        <i class="ri-message-3-line"></i>
        <p style="color:var(--muted);font-size:.85em">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</p>
      </div>
    </div>
    <div class="chat-input-row">
      <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." onkeydown="if(event.key==='Enter')sendChat()">
      <button onclick="sendChat()"><i class="ri-send-plane-fill"></i></button>
    </div>
  </div>
</div>
```

  </div>

  <!-- BROWSE ROOMS -->

  <div id="groupTabBrowse" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <span class="section-title">ğŸŒ Ø§Ù„ØºØ±Ù Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
      <button class="btn-premium" style="padding:7px 14px;font-size:12px" onclick="loadPublicRooms()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
    </div>
    <div id="publicRoomsList">
      <div class="waiting-screen">
        <i class="ri-search-line"></i>
        <p style="color:var(--muted);font-size:.85em;margin-top:8px">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...</p>
      </div>
    </div>
  </div>

  <!-- JOIN BY CODE -->

  <div id="groupTabJoin" style="display:none">
    <div class="glass-card">
      <h4 style="margin-bottom:16px">ğŸ”‘ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¨ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©</h4>
      <input type="text" id="joinCode" class="field-input" placeholder="MAS-XXXX" style="text-align:center;font-family:var(--font-mono);font-size:1.3em;letter-spacing:4px;margin-bottom:12px">
      <button class="btn-premium" style="width:100%" onclick="joinRoomByCode()">Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©</button>
    </div>
  </div>

  <!-- LEADERBOARD -->

  <div id="groupTabLeader" style="display:none">
    <div class="glass-card">
      <h4 style="margin-bottom:16px">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h4>
      <div id="leaderboardList">
        <div style="text-align:center;color:var(--muted);padding:20px">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>
  </div>
</div>

<!-- ======= PAGE: ARENA (REAL MATCHMAKING) ======= -->

<div id="pageArena" class="page">
  <h2 style="font-family:'Noto Kufi Arabic';margin-bottom:20px">âš”ï¸ Ø³Ø§Ø­Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</h2>

  <!-- LOBBY -->

  <div id="arenaLobby">
    <div class="glass-card" style="text-align:center;margin-bottom:15px;padding:30px">
      <i class="ri-sword-fill" style="font-size:50px;color:var(--gold);display:block;margin-bottom:10px"></i>
      <h3 style="margin:0 0 8px">Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©ØŸ</h3>
      <p style="color:var(--muted);font-size:.9em;margin-bottom:20px">ØªØ­Ø¯ÙŠ Ø·Ù„Ø§Ø¨ Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ† ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</p>

```
  <div style="margin-bottom:14px">
    <label class="field-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</label>
    <select id="arenaSubjectSelect" class="field-input" style="margin-bottom:12px">
      <option value="general">Ø¹Ø§Ù… (ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯)</option>
      <option value="math">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
      <option value="physics">ÙÙŠØ²ÙŠØ§Ø¡</option>
      <option value="chemistry">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
      <option value="biology">Ø£Ø­ÙŠØ§Ø¡</option>
    </select>
  </div>

  <button class="btn-premium" style="margin-bottom:10px;width:100%" onclick="findRealMatch()">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
  <button class="btn-premium btn-purple" style="width:100%" onclick="startSoloChallenge()">ğŸ¯ ØªØ­Ø¯ÙŠ ÙØ±Ø¯ÙŠ</button>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
  <div class="stat-mini"><div class="num" id="arenaWins">0</div><div class="lbl">Ø§Ù†ØªØµØ§Ø±Ø§Øª</div></div>
  <div class="stat-mini"><div class="num" id="arenaRating">1000</div><div class="lbl">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div></div>
</div>
```

  </div>

  <!-- MATCHMAKING SCREEN -->

  <div id="arenaMatchmaking" style="display:none">
    <div class="glass-card matchmaking-pulse">
      <div class="pulse-ring">
        <i class="ri-sword-fill" style="font-size:30px;color:var(--gold);position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)"></i>
      </div>
      <h3>Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø§ÙØ³...</h3>
      <p style="color:var(--muted);font-size:.85em;margin:10px 0" id="matchmakingStatus">ÙŠØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù„Ø§Ø¹Ø¨ ÙÙŠ Ù†ÙØ³ Ù…Ø³ØªÙˆØ§Ùƒ</p>
      <div style="font-family:var(--font-mono);color:var(--gold);font-size:1.4em;margin:10px 0" id="matchTimer">0:00</div>
      <button class="btn-premium btn-red" style="margin-top:10px" onclick="cancelMatchmaking()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
    </div>
  </div>

  <!-- GAME SCREEN -->

  <div id="arenaGame" style="display:none">
    <div class="arena-vs">
      <div class="arena-player" id="p1Card">
        <div style="font-size:1.5em;margin-bottom:5px">ğŸ§‘</div>
        <div style="font-weight:700;font-size:.9em" id="player1Name">Ø£Ù†Øª</div>
        <div style="font-family:var(--font-mono);color:var(--gold);font-size:1.4em" id="player1Score">0</div>
      </div>
      <div class="arena-vs-badge">VS</div>
      <div class="arena-player" id="p2Card">
        <div style="font-size:1.5em;margin-bottom:5px">ğŸ§‘</div>
        <div style="font-weight:700;font-size:.9em" id="player2Name">Ù…Ù†Ø§ÙØ³</div>
        <div style="font-family:var(--font-mono);color:var(--rose);font-size:1.4em" id="player2Score">0</div>
      </div>
    </div>
    <div class="glass-card">
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
        <span>Ø§Ù„Ø³Ø¤Ø§Ù„ <span id="qNum">1</span>/5</span>
        <span style="font-family:var(--font-mono);font-size:1.2em;color:var(--gold)" id="qTimer">10</span>
      </div>
      <!-- Timer bar -->
      <div class="prog-bar" style="margin-bottom:14px"><div id="timerBar" class="prog-fill" style="width:100%;background:linear-gradient(90deg,var(--rose),var(--gold));transition:width 1s linear"></div></div>
      <p id="qText" style="font-size:1.05em;font-weight:600;margin-bottom:16px;line-height:1.6"></p>
      <div id="qOptions"></div>
      <div id="opponentStatus" style="font-size:.8em;color:var(--muted);text-align:center;margin-top:10px;height:20px"></div>
    </div>
  </div>

  <!-- RESULT SCREEN -->

  <div id="arenaResult" style="display:none">
    <div class="glass-card" style="text-align:center;padding:35px">
      <div style="font-size:4em;margin-bottom:10px" id="resultEmoji">ğŸ†</div>
      <h2 id="resultTitle" style="font-family:'Noto Kufi Arabic';margin-bottom:8px">Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
      <p id="resultDesc" style="color:var(--muted);margin-bottom:20px"></p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
        <div class="stat-mini"><div class="num" id="resultMyScore">0</div><div class="lbl">Ù†Ù‚Ø§Ø·Ùƒ</div></div>
        <div class="stat-mini"><div class="num" id="resultOppScore">0</div><div class="lbl">Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù†Ø§ÙØ³</div></div>
      </div>
      <button class="btn-premium" style="width:100%" onclick="backToLobby()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ø§Ø­Ø©</button>
    </div>
  </div>
</div>

<!-- ======= PAGE: MIZAN ======= -->

<div id="pageMizan" class="page">
  <div style="text-align:center;padding:30px 0 20px">
    <i class="ri-shield-flash-line" style="font-size:70px;color:var(--gold)"></i>
    <h1 style="font-family:'Noto Kufi Arabic';margin-top:8px">Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…ÙŠØ²Ø§Ù† <span class="mizan-badge">LMS</span></h1>
    <p style="color:var(--muted);font-size:.85em">ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</p>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
    <div class="stat-mini"><div class="num" id="mzCommit">0%</div><div class="lbl">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</div></div>
    <div class="stat-mini"><div class="num" id="mzHours">0<small style="font-size:12px">h</small></div><div class="lbl">Ø§Ù„ØªØ±ÙƒÙŠØ²</div></div>
    <div class="stat-mini"><div class="num" id="mizanStreak">0</div><div class="lbl">ÙŠÙˆÙ… Ù…ØªÙˆØ§ØµÙ„</div></div>
    <div class="stat-mini"><div class="num" id="mizanGroups">0</div><div class="lbl">Ø¬Ù„Ø³Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©</div></div>
  </div>
  <div class="glass-card" style="margin-bottom:15px">
    <h3 style="margin-bottom:12px">ğŸ›¡ï¸ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±</h3>
    <p style="font-size:.85em;color:var(--muted)">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙŠØ²Ø§Ù† ÙŠØªØªØ¨Ø¹ Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø²ÙƒØŒ Ø¬Ù„Ø³Ø§ØªÙƒ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©ØŒ ÙˆÙ†ØªØ§Ø¦Ø¬ ØªØ­Ø¯ÙŠØ§ØªÙƒ.</p>
    <div style="margin-top:15px">
      <div style="display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:5px">
        <span>Ù‡Ø¯Ù Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span><span id="weeklyPct">0%</span>
      </div>
      <div class="prog-bar"><div class="prog-fill" id="weeklyProg" style="width:0%"></div></div>
    </div>
  </div>
  <!-- Top Studiers Leaderboard -->
  <div class="glass-card">
    <h3 style="margin-bottom:14px">ğŸŒŸ Ù†Ø®Ø¨Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
    <div id="mizanLeaderboard"><div style="color:var(--muted);font-size:.85em">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
  </div>
</div>

<!-- Firebase SDKs -->

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
/* =========================================================
   FIREBASE CONFIG
   ========================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyDeBAgXm6L3NPTitSuzkS37ZFoyy_UvMHk",
  authDomain: "masar-5db30.firebaseapp.com",
  projectId: "masar-5db30",
  storageBucket: "masar-5db30.firebasestorage.app",
  messagingSenderId: "909223400853",
  appId: "1:909223400853:web:a64c4e243de8c1dc15d29c",
  databaseURL: "https://masar-5db30-default-rtdb.firebaseio.com"
};

if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const db  = firebase.firestore();
const auth = firebase.auth();
const rtdb = firebase.database(); // Realtime DB for live features

/* =========================================================
   STATE
   ========================================================= */
let currentUser = null;
let authMode = 'login';
let userProfile = { name:'', subjects:[], schedule:[], streak:0, completedTasks:0, totalHours:0, arenaWins:0, arenaRating:1000, mizanGroups:0 };

// Group room state
let currentRoomId = null;
let roomMembersListener = null;
let roomChatListener = null;
let roomMetaListener = null;

// Arena state
let arenaMatchId = null;
let arenaMatchListener = null;
let matchmakingInterval = null;
let matchTimerInterval = null;
let matchTimerSec = 0;

// Timers
let sessionRunning = false;
let sessionSeconds = 0;
let sessionInterval = null;
let pomodoroRunning = false;
let pomodoroSeconds = 25*60;
let pomodoroPhase = 'focus';
let pomInterv = null;
const POM_FOCUS = 25*60;
const POM_BREAK = 5*60;
const TOTAL_CIRC = 295.3;

let currentLang = 'ar';

/* =========================================================
   AUTH
   ========================================================= */
auth.onAuthStateChanged(async user => {
  if(user){
    currentUser = user;
    document.getElementById('authOverlay').style.display = 'none';
    document.getElementById('bottomNav').style.display = 'flex';
    await loadUserData(user.uid);
    updateOnlinePresence();
    trackOnlineUsers();
    updatePomUI();
  } else {
    currentUser = null;
    if(currentRoomId) await leaveRoom(true);
    document.getElementById('authOverlay').style.display = 'flex';
    document.getElementById('bottomNav').style.display = 'none';
  }
});

function toggleAuthMode(){
  authMode = authMode==='login'?'signup':'login';
  document.getElementById('authLoginBtn').textContent = authMode==='signup'?'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯':'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ù†ØµØ©';
  document.getElementById('authSignupLink').textContent = authMode==='signup'?'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„':'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†';
}

async function handleAuth(){
  const email = document.getElementById('userEmail').value.trim();
  const pass  = document.getElementById('userPass').value;
  if(!email||!pass) return showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
  try{
    if(authMode==='signup'){
      const cred = await auth.createUserWithEmailAndPassword(email,pass);
      await cred.user.sendEmailVerification();
      showToast('ğŸ“§ ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡! ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø±ÙŠØ¯Ùƒ');
    } else {
      await auth.signInWithEmailAndPassword(email,pass);
      showToast('âœ… Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø³Ø§Ø±!');
    }
  } catch(e){
    const msgs = {'auth/email-already-in-use':'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','auth/weak-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)','auth/user-not-found':'Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','auth/wrong-password':'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','auth/invalid-email':'Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­'};
    showToast('âŒ ' + (msgs[e.code] || e.message));
  }
}

async function forgotPassword(){
  const email = document.getElementById('userEmail').value.trim();
  if(!email) return showToast('âš ï¸ Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹');
  try{ await auth.sendPasswordResetEmail(email); showToast('ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'); }
  catch(e){ showToast('âŒ ' + e.message); }
}

async function loginWithGoogle(){
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    showToast('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„');
  } catch(e){ showToast('âŒ ' + e.message); }
}

/* =========================================================
   USER DATA
   ========================================================= */
async function loadUserData(uid){
  try{
    const doc = await db.collection('users').doc(uid).get();
    if(doc.exists){ userProfile = {...userProfile,...doc.data()}; }
    else {
      // New user: create profile
      await db.collection('users').doc(uid).set(userProfile);
    }
    document.getElementById('studentName').value = userProfile.name || '';
    renderSubjects();
    if(userProfile.schedule && userProfile.schedule.length) renderSchedule();
    updateStats();
    updateMizanPage();
    document.getElementById('arenaWins').textContent   = userProfile.arenaWins || 0;
    document.getElementById('arenaRating').textContent = userProfile.arenaRating || 1000;
  } catch(e){ console.error('loadUserData',e); }
}

async function saveProfile(){
  if(!currentUser) return;
  userProfile.name = document.getElementById('studentName').value.trim();
  await db.collection('users').doc(currentUser.uid).set(userProfile, {merge:true});
  showToast('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

/* =========================================================
   ONLINE PRESENCE (Realtime)
   ========================================================= */
function updateOnlinePresence(){
  if(!currentUser) return;
  const ref = rtdb.ref('online/' + currentUser.uid);
  ref.set({ name: userProfile.name || currentUser.email.split('@')[0], at: firebase.database.ServerValue.TIMESTAMP });
  ref.onDisconnect().remove();
}

function trackOnlineUsers(){
  rtdb.ref('online').on('value', snap => {
    const count = snap.numChildren();
    document.getElementById('onlineCount').textContent = count;
  });
}

/* =========================================================
   SUBJECTS
   ========================================================= */
function addSubject(){
  const name = document.getElementById('subjName').value.trim();
  const diff = parseInt(document.getElementById('subjDiff').value);
  if(!name) return showToast('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©');
  userProfile.subjects = userProfile.subjects || [];
  userProfile.subjects.push({id:Date.now(),name,diff});
  document.getElementById('subjName').value='';
  renderSubjects(); saveProfile();
}

function removeSubject(id){
  userProfile.subjects = userProfile.subjects.filter(s=>s.id!==id);
  renderSubjects(); saveProfile();
}

function renderSubjects(){
  const c = document.getElementById('subjectsList');
  if(!userProfile.subjects||!userProfile.subjects.length){c.innerHTML='';return}
  c.innerHTML = userProfile.subjects.map(s=>`
    <div class="task-item" style="border-inline-end-color:${s.diff===3?'var(--rose)':s.diff===2?'var(--gold)':'var(--teal)'}">
      <div style="flex:1"><strong>${s.name}</strong></div>
      <div style="font-size:.75em;color:var(--muted)">${s.diff===3?'ØµØ¹Ø¨Ø©':s.diff===2?'Ù…ØªÙˆØ³Ø·Ø©':'Ø³Ù‡Ù„Ø©'}</div>
      <i class="ri-delete-bin-line" style="color:var(--rose);cursor:pointer" onclick="removeSubject(${s.id})"></i>
    </div>
  `).join('');
}

/* =========================================================
   AI SCHEDULE
   ========================================================= */
function generateAISchedule(){
  if(!userProfile.subjects||!userProfile.subjects.length) return showToast('Ø£Ø¶Ù Ù…ÙˆØ§Ø¯Ø§Ù‹ Ø¯Ø±Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!');
  showToast('ğŸª„ Ø¬Ø§Ø±Ù Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°ÙƒÙŠ...');
  const peak = document.getElementById('peakTime').value;
  const days = [['Ø§Ù„Ø³Ø¨Øª','Saturday'],['Ø§Ù„Ø£Ø­Ø¯','Sunday'],['Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Monday'],['Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Tuesday'],['Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Wednesday'],['Ø§Ù„Ø®Ù…ÙŠØ³','Thursday'],['Ø§Ù„Ø¬Ù…Ø¹Ø©','Friday']];
  const sorted = [...userProfile.subjects].sort((a,b)=>b.diff-a.diff);
  userProfile.schedule = days.map((day,i)=>({
    dayAr:day[0], dayEn:day[1],
    tasks:[
      {time:peak==='morning'?'05:00':'16:00', subject:sorted[i%sorted.length].name, typeAr:'ØªØ±ÙƒÙŠØ² Ø¹Ù…ÙŠÙ‚', typeEn:'Deep Focus', done:false},
      {time:peak==='morning'?'09:00':'20:00', subject:sorted[(i+1)%sorted.length].name, typeAr:'Ù…Ø±Ø§Ø¬Ø¹Ø©', typeEn:'Review', done:false}
    ]
  }));
  renderSchedule(); saveProfile(); goPage('pageSchedule');
}

function renderSchedule(){
  const c = document.getElementById('scheduleContainer');
  const wm = document.getElementById('welcomeMsg');
  if(userProfile.name) wm.textContent = 'Ø®Ø·Ø© ' + userProfile.name;
  c.innerHTML = (userProfile.schedule||[]).map((day,di)=>`
    <div class="glass-card">
      <h4 style="color:var(--gold);border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:14px">
        ${currentLang==='ar'?day.dayAr:day.dayEn}
      </h4>
      ${(day.tasks||[]).map((tk,ti)=>`
        <div class="task-item" style="opacity:${tk.done?.5:1}">
          <div class="task-time">${tk.time}</div>
          <div style="flex:1">
            <div style="font-weight:bold;${tk.done?'text-decoration:line-through':''}">${tk.subject}</div>
            <div style="font-size:.75em;color:var(--muted)">${currentLang==='ar'?tk.typeAr:tk.typeEn}</div>
          </div>
          <i class="ri-checkbox-circle-${tk.done?'fill':'line'}" style="font-size:22px;color:${tk.done?'var(--teal)':'var(--muted)'};cursor:pointer" onclick="toggleTask(${di},${ti})"></i>
        </div>
      `).join('')}
    </div>
  `).join('');
  updateStats();
}

function toggleTask(di,ti){
  userProfile.schedule[di].tasks[ti].done = !userProfile.schedule[di].tasks[ti].done;
  renderSchedule(); saveProfile();
}

function updateStats(){
  const total = (userProfile.schedule||[]).reduce((a,d)=>a+(d.tasks||[]).length,0);
  const done  = (userProfile.schedule||[]).reduce((a,d)=>a+(d.tasks||[]).filter(t=>t.done).length,0);
  const pct   = total?Math.round(done/total*100):0;
  document.getElementById('todayPct').textContent = pct+'%';
  document.getElementById('todayProg').style.width = pct+'%';
  document.getElementById('completedTasks').textContent = done;
  document.getElementById('totalHours').textContent = Math.round(done*1.5);
  document.getElementById('streakNum').textContent = userProfile.streak||0;
}

function updateMizanPage(){
  const total = (userProfile.schedule||[]).reduce((a,d)=>a+(d.tasks||[]).length,0);
  const done  = (userProfile.schedule||[]).reduce((a,d)=>a+(d.tasks||[]).filter(t=>t.done).length,0);
  const pct   = total?Math.round(done/total*100):0;
  document.getElementById('mzCommit').textContent = pct+'%';
  document.getElementById('mzHours').innerHTML = Math.round((userProfile.totalHours||0))+'<small style="font-size:12px">h</small>';
  document.getElementById('mizanStreak').textContent = userProfile.streak||0;
  document.getElementById('mizanGroups').textContent = userProfile.mizanGroups||0;
  document.getElementById('weeklyPct').textContent = pct+'%';
  document.getElementById('weeklyProg').style.width = pct+'%';
  loadMizanLeaderboard();
}

async function loadMizanLeaderboard(){
  try{
    const snap = await db.collection('users').orderBy('arenaRating','desc').limit(10).get();
    const el = document.getElementById('mizanLeaderboard');
    if(snap.empty){ el.innerHTML='<div style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>'; return; }
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    el.innerHTML = snap.docs.map((d,i)=>{
      const u = d.data();
      const isMe = d.id===currentUser?.uid;
      return `<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);${isMe?'background:rgba(212,175,55,.05);border-radius:8px;padding-left:8px':''}">
        <span style="font-size:1.2em;width:28px;text-align:center">${medals[i]||'#'+(i+1)}</span>
        <div style="flex:1">
          <strong>${u.name||'Ù…Ø¬Ù‡ÙˆÙ„'}${isMe?' (Ø£Ù†Øª)':''}</strong>
          <div style="font-size:11px;color:var(--muted)">ğŸ† ${u.arenaRating||1000} Â· ğŸ”¥ ${u.streak||0}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e){ console.error(e); }
}

/* =========================================================
   GROUP STUDY â€“ REAL ROOMS (Firestore + Realtime DB)
   ========================================================= */

function groupTab(tab){
  ['myRoom','browse','join','leader'].forEach(t=>{
    const key = 'groupTab'+t.charAt(0).toUpperCase()+t.slice(1);
    const el = document.getElementById(key);
    if(el) el.style.display = t===tab?'block':'none';
  });
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const map = {myRoom:'tabMyRoom',browse:'tabBrowse',join:'tabJoin',leader:'tabLeader'};
  document.getElementById(map[tab])?.classList.add('active');
  if(tab==='browse') loadPublicRooms();
  if(tab==='leader') loadGroupLeaderboard();
}

async function createRoom(){
  if(!currentUser) return;
  const roomName = document.getElementById('roomNameInput').value.trim() || (userProfile.name?userProfile.name+'\'s Room':'ØºØ±ÙØ© Ø¯Ø±Ø§Ø³ÙŠØ©');
  const subject  = document.getElementById('roomSubjectSelect').value || 'Ø¹Ø§Ù…';
  const privacy  = document.getElementById('roomPrivacy').value;

  // Generate short code
  const code = 'MAS-' + Math.random().toString(36).substring(2,6).toUpperCase();

  try{
    const roomRef = await db.collection('rooms').add({
      name: roomName,
      subject: subject,
      privacy: privacy,
      code: code,
      createdBy: currentUser.uid,
      creatorName: userProfile.name || currentUser.email.split('@')[0],
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      memberCount: 1,
      active: true
    });

    currentRoomId = roomRef.id;
    await joinRoomInternal(currentRoomId, code, roomName);
    showToast('ğŸš€ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©!');
  } catch(e){ console.error(e); showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©'); }
}

async function joinRoomByCode(){
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if(!code) return showToast('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
  try{
    const snap = await db.collection('rooms').where('code','==',code).where('active','==',true).limit(1).get();
    if(snap.empty) return showToast('âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„ØºØ±ÙØ© Ù…ØºÙ„Ù‚Ø©');
    const roomDoc = snap.docs[0];
    await joinRoomInternal(roomDoc.id, code, roomDoc.data().name);
    groupTab('myRoom');
    showToast('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©!');
  } catch(e){ console.error(e); showToast('âŒ '+e.message); }
}

async function joinRoomFromBrowse(roomId, code, roomName){
  await joinRoomInternal(roomId, code, roomName);
  groupTab('myRoom');
  showToast('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…!');
}

async function joinRoomInternal(roomId, code, roomName){
  if(currentRoomId && currentRoomId !== roomId) await leaveRoom(true);
  currentRoomId = roomId;

  // Add member to Realtime DB (fast presence)
  const memberRef = rtdb.ref(`rooms/${roomId}/members/${currentUser.uid}`);
  await memberRef.set({
    name: userProfile.name || currentUser.email.split('@')[0],
    email: currentUser.email,
    joinedAt: firebase.database.ServerValue.TIMESTAMP,
    status: 'online'
  });
  memberRef.onDisconnect().remove();

  // Update Firestore member count
  db.collection('rooms').doc(roomId).update({
    memberCount: firebase.firestore.FieldValue.increment(1)
  }).catch(()=>{});

  // Show active room UI
  document.getElementById('createRoomSection').style.display = 'none';
  document.getElementById('activeRoomSection').style.display = 'block';
  document.getElementById('activeRoomName').textContent = roomName;
  document.getElementById('myInviteCode').textContent = code;

  // Listen to members
  listenToRoomMembers(roomId);
  // Listen to chat
  listenToRoomChat(roomId);

  // Send join system message
  sendSystemMessage(roomId, (userProfile.name||'Ù…Ø³ØªØ®Ø¯Ù…') + ' Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ© ğŸ‘‹');
  
  document.getElementById('groupNotif').style.display = 'none';
  userProfile.mizanGroups = (userProfile.mizanGroups||0) + 1;
  document.getElementById('mizanGroups').textContent = userProfile.mizanGroups;
  saveProfile();
}

function listenToRoomMembers(roomId){
  if(roomMembersListener) roomMembersListener();
  const ref = rtdb.ref(`rooms/${roomId}/members`);
  roomMembersListener = () => ref.off();
  
  ref.on('value', snap => {
    const members = [];
    snap.forEach(child => members.push({id:child.key, ...child.val()}));
    
    document.getElementById('membersCount').textContent = `${members.length} / 20`;
    document.getElementById('membersList').innerHTML = members.length
      ? members.map(m=>`
          <div class="member-chip">
            <div class="member-dot ${m.id===currentUser?.uid?'':''}"></div>
            <span>${m.name}${m.id===currentUser?.uid?' (Ø£Ù†Øª)':''}</span>
          </div>
        `).join('')
      : '<div style="color:var(--muted);font-size:.85em">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡</div>';
  });
}

function listenToRoomChat(roomId){
  if(roomChatListener) roomChatListener();
  const ref = rtdb.ref(`rooms/${roomId}/chat`).limitToLast(50);
  roomChatListener = () => ref.off();
  
  let firstLoad = true;
  ref.on('value', snap => {
    const msgs = [];
    snap.forEach(child => msgs.push({id:child.key, ...child.val()}));
    
    const chatEl = document.getElementById('groupChat');
    if(!msgs.length){
      chatEl.innerHTML = '<div class="waiting-screen" style="padding:20px"><i class="ri-message-3-line"></i><p style="color:var(--muted);font-size:.85em;margin-top:8px">ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©!</p></div>';
      return;
    }
    
    chatEl.innerHTML = msgs.map(m=>{
      if(m.system) return `<div class="system-msg">${m.text}</div>`;
      const isOwn = m.uid === currentUser?.uid;
      const initial = (m.name||'?')[0];
      const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit'}) : '';
      return `<div class="chat-msg${isOwn?' own-msg':''}">
        <div class="chat-avatar">${initial}</div>
        <div class="chat-bubble">
          <div class="chat-name">${m.name}${isOwn?' (Ø£Ù†Øª)':''}</div>
          ${m.text}
          <div class="chat-time">${time}</div>
        </div>
      </div>`;
    }).join('');
    
    chatEl.scrollTop = chatEl.scrollHeight;
    firstLoad = false;
  });
}

async function sendChat(){
  if(!currentUser || !currentRoomId) return;
  const inp = document.getElementById('chatInput');
  const text = inp.value.trim();
  if(!text) return;
  inp.value = '';
  
  try{
    await rtdb.ref(`rooms/${currentRoomId}/chat`).push({
      uid: currentUser.uid,
      name: userProfile.name || currentUser.email.split('@')[0],
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });
  } catch(e){ showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); console.error(e); }
}

async function sendSystemMessage(roomId, text){
  await rtdb.ref(`rooms/${roomId}/chat`).push({
    system: true,
    text: text,
    timestamp: firebase.database.ServerValue.TIMESTAMP
  });
}

async function leaveRoom(silent = false){
  if(!currentRoomId || !currentUser) return;
  
  // Remove from realtime presence
  await rtdb.ref(`rooms/${currentRoomId}/members/${currentUser.uid}`).remove();
  
  // Update member count
  db.collection('rooms').doc(currentRoomId).update({
    memberCount: firebase.firestore.FieldValue.increment(-1)
  }).catch(()=>{});

  // Send leave message
  if(!silent) sendSystemMessage(currentRoomId, (userProfile.name||'Ù…Ø³ØªØ®Ø¯Ù…') + ' ØºØ§Ø¯Ø± Ø§Ù„ØºØ±ÙØ© ğŸ‘‹');

  // Stop timers
  if(sessionRunning) toggleSession();
  if(pomodoroRunning) { clearInterval(pomInterv); pomodoroRunning=false; }

  // Detach listeners
  if(roomMembersListener){ roomMembersListener(); roomMembersListener=null; }
  if(roomChatListener){ roomChatListener(); roomChatListener=null; }

  currentRoomId = null;
  
  // Reset UI
  document.getElementById('activeRoomSection').style.display = 'none';
  document.getElementById('createRoomSection').style.display = 'block';
  sessionSeconds = 0;
  document.getElementById('sessionTimer').textContent = '00:00:00';
  document.getElementById('membersList').innerHTML = '<div style="color:var(--muted);font-size:.85em">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯...</div>';
  document.getElementById('groupChat').innerHTML = '';

  if(!silent) showToast('ğŸ‘‹ ØºØ§Ø¯Ø±Øª Ø§Ù„ØºØ±ÙØ©');
}

async function loadPublicRooms(){
  const el = document.getElementById('publicRoomsList');
  el.innerHTML = '<div class="waiting-screen"><i class="ri-search-line"></i><p style="color:var(--muted);font-size:.85em;margin-top:8px">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
  try{
    const snap = await db.collection('rooms').where('privacy','==','public').where('active','==',true).orderBy('createdAt','desc').limit(20).get();
    if(snap.empty){ el.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø£Ù†Ø´Ø¦ ØºØ±ÙØªÙƒ!</div>'; return; }
    el.innerHTML = snap.docs.map(d=>{
      const r = d.data();
      const isInRoom = d.id === currentRoomId;
      return `<div class="room-card${isInRoom?' active-room':''}">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <strong>${r.name}</strong>
            ${isInRoom?'<span style="font-size:10px;color:var(--teal);margin-inline-start:6px">âœ“ Ø£Ù†Øª Ù‡Ù†Ø§</span>':''}
            <div style="font-size:12px;color:var(--muted);margin-top:4px">ğŸ“š ${r.subject} Â· ğŸ‘¥ ${r.memberCount||1} Â· Ø¨ÙˆØ§Ø³Ø·Ø© ${r.creatorName}</div>
          </div>
          ${isInRoom
            ? '<button class="btn-premium btn-red" style="padding:7px 12px;font-size:11px" onclick="leaveRoom()">Ù…ØºØ§Ø¯Ø±Ø©</button>'
            : `<button class="btn-premium btn-purple" style="padding:7px 12px;font-size:11px" onclick="joinRoomFromBrowse('${d.id}','${r.code}','${r.name.replace(/'/g,"\\'")}')">Ø§Ù†Ø¶Ù…Ø§Ù…</button>`}
        </div>
      </div>`;
    }).join('');
  } catch(e){ 
    console.error(e); 
    el.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">âš ï¸ ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ.</div>'; 
  }
}

async function loadGroupLeaderboard(){
  try{
    const snap = await db.collection('users').orderBy('mizanGroups','desc').limit(10).get();
    const el = document.getElementById('leaderboardList');
    if(snap.empty){ el.innerHTML='<div style="color:var(--muted)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>'; return; }
    const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
    el.innerHTML = snap.docs.map((d,i)=>{
      const u=d.data();
      const isMe = d.id===currentUser?.uid;
      return `<div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);${isMe?'border-radius:8px;background:rgba(212,175,55,.05)':''}">
        <span style="font-size:1.3em;width:30px;text-align:center">${medals[i]||'#'+(i+1)}</span>
        <div style="flex:1">
          <strong>${u.name||'Ù…Ø¬Ù‡ÙˆÙ„'}${isMe?' (Ø£Ù†Øª)':''}</strong>
          <div style="font-size:11px;color:var(--muted)">ğŸ§‘â€ğŸ¤â€ğŸ§‘ ${u.mizanGroups||0} Ø¬Ù„Ø³Ø© Â· â± ${Math.round(u.totalHours||0)}h</div>
        </div>
      </div>`;
    }).join('');
  } catch(e){ console.error(e); }
}

function copyCode(){
  const code = document.getElementById('myInviteCode').textContent;
  navigator.clipboard?.writeText(code).catch(()=>{});
  showToast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: '+code);
}

function shareRoom(){
  const code = document.getElementById('myInviteCode').textContent;
  const roomName = document.getElementById('activeRoomName').textContent;
  if(navigator.share){
    navigator.share({title:'Ù…Ø³Ø§Ø± - Ø¯Ø¹ÙˆØ© Ù„Ù„Ø¯Ø±Ø§Ø³Ø©', text:`Ø§Ù†Ø¶Ù… Ù„ØºØ±ÙØ© "${roomName}" ÙÙŠ Ù…Ø³Ø§Ø±! ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø¹ÙˆØ©: ${code}`, url:window.location.href});
  } else copyCode();
}

/* =========================================================
   SESSION TIMER
   ========================================================= */
function toggleSession(){
  if(sessionRunning){
    clearInterval(sessionInterval); sessionRunning=false;
    document.getElementById('sessionBtn').textContent = 'â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©';
    userProfile.totalHours = (userProfile.totalHours||0) + Math.round(sessionSeconds/3600*10)/10;
    saveProfile();
    // Broadcast to room
    if(currentRoomId) sendSystemMessage(currentRoomId, 'â¸ ' + (userProfile.name||'Ù…Ø³ØªØ®Ø¯Ù…') + ' Ø£ÙˆÙ‚Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø¤Ù‚ØªØ§Ù‹');
  } else {
    sessionRunning=true;
    document.getElementById('sessionBtn').textContent = 'â¸ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª';
    sessionInterval = setInterval(()=>{
      sessionSeconds++;
      const h=String(Math.floor(sessionSeconds/3600)).padStart(2,'0');
      const m=String(Math.floor((sessionSeconds%3600)/60)).padStart(2,'0');
      const s=String(sessionSeconds%60).padStart(2,'0');
      document.getElementById('sessionTimer').textContent=`${h}:${m}:${s}`;
    },1000);
    if(currentRoomId) sendSystemMessage(currentRoomId, 'â–¶ ' + (userProfile.name||'Ù…Ø³ØªØ®Ø¯Ù…') + ' Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ù„Ø³Ø©!');
  }
}

function endSession(){
  if(sessionRunning) toggleSession();
  sessionSeconds=0;
  document.getElementById('sessionTimer').textContent='00:00:00';
  showToast('ğŸ“Š ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©');
  if(currentRoomId) sendSystemMessage(currentRoomId, 'âœ… Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©');
}

/* =========================================================
   POMODORO
   ========================================================= */
function togglePomodoro(){
  if(pomodoroRunning){
    clearInterval(pomInterv); pomodoroRunning=false;
    document.getElementById('pomBtn').textContent='Ø¨Ø¯Ø¡';
  } else {
    pomodoroRunning=true;
    document.getElementById('pomBtn').textContent='â¸ Ø¥ÙŠÙ‚Ø§Ù';
    pomInterv=setInterval(()=>{
      pomodoroSeconds--;
      updatePomUI();
      if(pomodoroSeconds<=0){
        clearInterval(pomInterv); pomodoroRunning=false;
        pomodoroPhase=pomodoroPhase==='focus'?'break':'focus';
        pomodoroSeconds=pomodoroPhase==='focus'?POM_FOCUS:POM_BREAK;
        document.getElementById('pomLabel').textContent=pomodoroPhase==='focus'?'ØªØ±ÙƒÙŠØ²':'Ø§Ø³ØªØ±Ø§Ø­Ø©';
        const msg=pomodoroPhase==='focus'?'ğŸ“š ÙˆÙ‚Øª Ø§Ù„ØªØ±ÙƒÙŠØ²!':'â˜• ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©!';
        showToast(msg);
        if(currentRoomId) sendSystemMessage(currentRoomId, msg);
        updatePomUI();
      }
    },1000);
  }
}

function resetPomodoro(){
  clearInterval(pomInterv); pomodoroRunning=false;
  pomodoroPhase='focus'; pomodoroSeconds=POM_FOCUS;
  document.getElementById('pomBtn').textContent='Ø¨Ø¯Ø¡';
  document.getElementById('pomLabel').textContent='ØªØ±ÙƒÙŠØ²';
  updatePomUI();
}

function updatePomUI(){
  const total=pomodoroPhase==='focus'?POM_FOCUS:POM_BREAK;
  const m=String(Math.floor(pomodoroSeconds/60)).padStart(2,'0');
  const s=String(pomodoroSeconds%60).padStart(2,'0');
  document.getElementById('pomTime').textContent=`${m}:${s}`;
  const progress=pomodoroSeconds/total;
  document.getElementById('pomRing').style.strokeDashoffset=TOTAL_CIRC-(TOTAL_CIRC*progress);
}

/* =========================================================
   ARENA â€“ REAL MATCHMAKING (Firestore)
   ========================================================= */
const arenaQuestions = {
  general:[
    {q:'Ø£ÙƒØ«Ø± Ø¹Ù†ØµØ± ÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø´Ø±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©ØŸ',opts:['Ø§Ù„Ø­Ø¯ÙŠØ¯','Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†','Ø§Ù„Ø£Ù„Ù…Ù†ÙŠÙˆÙ…','Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…'],ans:1},
    {q:'Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙŠÙ†ÙŠØªÙŠØ©ØŸ',opts:['E=mcÂ²','KE=Â½mvÂ²','F=ma','P=mv'],ans:1},
    {q:'Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ù…ØªØ­Ø¯Ø©ØŸ',opts:['Ø¨Ø§Ø±ÙŠØ³','Ø¨Ø±Ù„ÙŠÙ†','Ù„Ù†Ø¯Ù†','Ø±ÙˆÙ…Ø§'],ans:2},
    {q:'Ø£ÙƒØ¨Ø± Ø®Ù„ÙŠØ© ÙÙŠ Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ØŸ',opts:['ÙƒØ±ÙŠØ© Ø­Ù…Ø±Ø§Ø¡','Ø¹ØµØ¨ÙŠØ©','Ø¨ÙˆÙŠØ¶Ø©','ÙƒØ¨Ø¯ÙŠØ©'],ans:2},
    {q:'ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ',opts:['26','28','30','32'],ans:1}
  ],
  math:[
    {q:'Ù†Ø§ØªØ¬ 7Â² ØŸ',opts:['14','42','49','56'],ans:2},
    {q:'Ù…Ø´ØªÙ‚Ø© sin(x) ØŸ',opts:['cos(x)','-cos(x)','sin(x)','-sin(x)'],ans:0},
    {q:'Ù‚ÙŠÙ…Ø© Ï€ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ØŸ',opts:['3.14','3.41','2.71','1.41'],ans:0},
    {q:'Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¥Ø°Ø§ r=5ØŸ',opts:['25Ï€','10Ï€','5Ï€','50Ï€'],ans:0},
    {q:'Ù†Ø³Ø¨Ø© Ø°Ù‡Ø¨ÙŠØ© = ØŸ',opts:['1.414','1.618','2.718','3.141'],ans:1}
  ],
  physics:[
    {q:'Ø³Ø±Ø¹Ø© Ø§Ù„Ø¶ÙˆØ¡ ÙÙŠ Ø§Ù„ÙØ±Ø§Øº (km/s)ØŸ',opts:['200,000','300,000','400,000','150,000'],ans:1},
    {q:'ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙˆØ©ØŸ',opts:['Ø¬ÙˆÙ„','ÙˆØ§Ø·','Ù†ÙŠÙˆØªÙ†','Ø¨Ø§Ø³ÙƒØ§Ù„'],ans:2},
    {q:'Ù‚Ø§Ù†ÙˆÙ† Ù†ÙŠÙˆØªÙ† Ø§Ù„Ø«Ø§Ù†ÙŠØŸ',opts:['F=ma','E=mcÂ²','P=mv','W=Fd'],ans:0},
    {q:'Ø£ÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ù…ÙˆØ¬Ø§Øª ÙƒÙ‡Ø±ÙˆÙ…ØºÙ†Ø§Ø·ÙŠØ³ÙŠØ©ØŸ',opts:['ØµÙˆØªÙŠØ©','Ø³Ø·Ø­ÙŠØ©','Ø±Ø§Ø¯ÙŠÙˆ','Ù…Ø§Ø¦ÙŠØ©'],ans:2},
    {q:'Ø§Ù„Ø´ØºÙ„ = ØŸ',opts:['FÃ—d','F/d','mÃ—a','PÃ—t'],ans:0}
  ],
  chemistry:[
    {q:'Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ Ù„Ù„Ø°Ù‡Ø¨ØŸ',opts:['Go','Gd','Au','Ag'],ans:2},
    {q:'Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø°Ø±ÙŠ Ù„Ù„ÙƒØ±Ø¨ÙˆÙ†ØŸ',opts:['6','12','8','14'],ans:0},
    {q:'ØµÙŠØºØ© Ø§Ù„Ù…Ø§Ø¡ØŸ',opts:['HO','Hâ‚‚O','Hâ‚‚Oâ‚‚','OH'],ans:1},
    {q:'Ø£ÙŠ Ù…Ù† Ù‡Ø°Ù‡ Ø­Ù…Ø¶ØŸ',opts:['NaOH','KOH','HCl','NaCl'],ans:2},
    {q:'Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ±ÙŠ ØµÙ…Ù… Ø¨ÙˆØ§Ø³Ø·Ø©ØŸ',opts:['Ù†ÙŠÙˆØªÙ†','Ù…Ù†Ø¯Ù„ÙŠÙ','ÙƒÙˆØ±ÙŠ','Ø¨ÙˆØ±'],ans:1}
  ],
  biology:[
    {q:'Ø¹Ø¯Ø¯ ÙƒØ±ÙˆÙ…ÙˆØ³ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ù†Ø³Ø§Ù†ØŸ',opts:['23','46','48','92'],ans:1},
    {q:'Ø¹Ø¶Ùˆ ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†ØŸ',opts:['Ù†ÙˆØ§Ø©','Ù…ÙŠØªÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§','Ø±ÙŠØ¨ÙˆØ³ÙˆÙ…','Ø¬ÙˆÙ„Ø¬ÙŠ'],ans:2},
    {q:'Ù…Ù† Ø§ÙƒØªØ´Ù Ø§Ù„Ø®Ù„ÙŠØ©ØŸ',opts:['Ø¯Ø§Ø±ÙˆÙŠÙ†','Ø¨Ø§Ø³ØªÙˆØ±','Ù‡ÙˆÙƒ','ÙˆØ§Ø·Ø³ÙˆÙ†'],ans:2},
    {q:'Ø§Ù„Ù€ DNA ÙŠÙˆØ¬Ø¯ ÙÙŠØŸ',opts:['Ø§Ù„Ø³ÙŠØªÙˆØ¨Ù„Ø§Ø²Ù…','Ø§Ù„Ù†ÙˆØ§Ø©','Ø§Ù„ØºØ´Ø§Ø¡','Ø§Ù„Ø±ÙŠØ¨ÙˆØ³ÙˆÙ…'],ans:1},
    {q:'ÙƒÙ… ØªØ³ØªØºØ±Ù‚ Ø¶Ø±Ø¨Ø© Ù‚Ù„Ø¨ØŸ',opts:['0.4 Ø«Ø§Ù†ÙŠØ©','0.8 Ø«Ø§Ù†ÙŠØ©','1.2 Ø«Ø§Ù†ÙŠØ©','2 Ø«Ø§Ù†ÙŠØ©'],ans:1}
  ]
};

let arenaState = {qIndex:0,p1:0,p2:0,timer:null,qTimer:10,isSolo:false,opponentId:null,opponentName:''};

async function findRealMatch(){
  if(!currentUser) return;
  const subject = document.getElementById('arenaSubjectSelect').value || 'general';
  
  document.getElementById('arenaLobby').style.display='none';
  document.getElementById('arenaMatchmaking').style.display='block';
  
  matchTimerSec=0;
  clearInterval(matchTimerInterval);
  matchTimerInterval=setInterval(()=>{
    matchTimerSec++;
    const m=Math.floor(matchTimerSec/60);
    const s=matchTimerSec%60;
    document.getElementById('matchTimer').textContent=`${m}:${String(s).padStart(2,'0')}`;
    // After 15s, offer to play solo
    if(matchTimerSec===15) document.getElementById('matchmakingStatus').textContent='Ù„Ù… Ù†Ø¬Ø¯ Ù…Ù†Ø§ÙØ³Ø§Ù‹... Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ…Ø¨Ø§Ø±Ø§Ø© Ø§Ù†ØªØ¸Ø§Ø±';
    if(matchTimerSec>=20){
      clearInterval(matchTimerInterval);
      startSoloChallenge(subject);
    }
  },1000);

  // Search for open lobby in Firestore
  try{
    const lookupsSnap = await db.collection('arenaQueue')
      .where('subject','==',subject)
      .where('status','==','waiting')
      .where('uid','!=',currentUser.uid)
      .limit(1).get();

    if(!lookupsSnap.empty){
      // Found a match!
      clearInterval(matchTimerInterval);
      const opDoc = lookupsSnap.docs[0];
      const matchRef = db.collection('arenaMatches').doc();
      const questions = arenaQuestions[subject] || arenaQuestions.general;
      
      await matchRef.set({
        player1: {uid:opDoc.data().uid, name:opDoc.data().name, score:0},
        player2: {uid:currentUser.uid, name:userProfile.name||'Ù„Ø§Ø¹Ø¨', score:0},
        subject: subject,
        questions: questions.map(q=>({q:q.q,opts:q.opts,ans:q.ans})),
        status: 'playing',
        qIndex: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Delete queue entry
      await opDoc.ref.delete();

      arenaMatchId = matchRef.id;
      startRealArenaGame(matchRef.id, 'player2', opDoc.data().name, subject);
    } else {
      // Enter queue as player1
      const queueRef = await db.collection('arenaQueue').add({
        uid: currentUser.uid,
        name: userProfile.name||'Ù„Ø§Ø¹Ø¨',
        subject: subject,
        status: 'waiting',
        at: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Listen for match creation
      matchmakingInterval = db.collection('arenaMatches')
        .where('player1.uid','==',currentUser.uid)
        .where('status','==','playing')
        .onSnapshot(snap=>{
          if(!snap.empty){
            clearInterval(matchTimerInterval);
            if(matchmakingInterval){ matchmakingInterval(); matchmakingInterval=null; }
            queueRef.delete();
            const matchDoc = snap.docs[0];
            arenaMatchId = matchDoc.id;
            startRealArenaGame(matchDoc.id, 'player1', matchDoc.data().player2.name, subject);
          }
        });
    }
  } catch(e){
    console.error('matchmaking error',e);
    clearInterval(matchTimerInterval);
    startSoloChallenge(subject);
  }
}

async function startRealArenaGame(matchId, myRole, opponentName, subject){
  document.getElementById('arenaMatchmaking').style.display='none';
  document.getElementById('arenaGame').style.display='block';
  
  arenaState = {qIndex:0,p1:0,p2:0,timer:null,qTimer:10,isSolo:false,matchId,myRole,opponentName,subject};
  
  document.getElementById('player1Name').textContent = myRole==='player1'?opponentName:(userProfile.name||'Ø£Ù†Øª');
  document.getElementById('player2Name').textContent = myRole==='player2'?opponentName:(userProfile.name||'Ø£Ù†Øª');
  
  // Swap color for "you"
  const myScoreEl  = myRole==='player1'?document.getElementById('player2Score'):document.getElementById('player1Score');
  const oppScoreEl = myRole==='player1'?document.getElementById('player1Score'):document.getElementById('player2Score');

  const qs = arenaQuestions[subject]||arenaQuestions.general;
  loadArenaQuestion(qs, myScoreEl, oppScoreEl);
}

function cancelMatchmaking(){
  clearInterval(matchTimerInterval);
  if(matchmakingInterval){ matchmakingInterval(); matchmakingInterval=null; }
  // Clean queue
  if(currentUser){
    db.collection('arenaQueue').where('uid','==',currentUser.uid).get().then(s=>s.forEach(d=>d.ref.delete()));
  }
  document.getElementById('arenaMatchmaking').style.display='none';
  document.getElementById('arenaLobby').style.display='block';
  showToast('âœ‹ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
}

function startSoloChallenge(subject){
  clearInterval(matchTimerInterval);
  if(matchmakingInterval){ matchmakingInterval(); matchmakingInterval=null; }
  document.getElementById('arenaMatchmaking').style.display='none';
  document.getElementById('arenaLobby').style.display='none';
  document.getElementById('arenaGame').style.display='block';
  
  const sub = subject || (document.getElementById('arenaSubjectSelect')?.value || 'general');
  arenaState = {qIndex:0,p1:0,p2:0,timer:null,qTimer:10,isSolo:true,subject:sub};
  
  document.getElementById('player1Name').textContent = userProfile.name||'Ø£Ù†Øª';
  document.getElementById('player2Name').textContent = 'ğŸ¤– Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ';
  
  const qs = arenaQuestions[sub]||arenaQuestions.general;
  loadArenaQuestion(qs, document.getElementById('player1Score'), document.getElementById('player2Score'));
}

function loadArenaQuestion(qs, myScoreEl, oppScoreEl){
  if(arenaState.qIndex >= qs.length) return endArena(myScoreEl, oppScoreEl);
  const q = qs[arenaState.qIndex];
  arenaState.qTimer=10;
  
  document.getElementById('qNum').textContent = arenaState.qIndex+1;
  document.getElementById('qText').textContent = q.q;
  document.getElementById('qOptions').innerHTML = q.opts.map((o,i)=>
    `<div class="q-option" onclick="answerArena(${i},${q.ans})">${o}</div>`
  ).join('');
  document.getElementById('opponentStatus').textContent='';
  document.getElementById('timerBar').style.width='100%';
  document.getElementById('timerBar').style.transition='none';
  setTimeout(()=>{document.getElementById('timerBar').style.transition='width 1s linear';},50);
  
  clearInterval(arenaState.timer);
  arenaState.timer = setInterval(()=>{
    arenaState.qTimer--;
    document.getElementById('qTimer').textContent=arenaState.qTimer;
    document.getElementById('timerBar').style.width=(arenaState.qTimer/10*100)+'%';
    
    // AI opponent might answer
    if(arenaState.isSolo && arenaState.qTimer===7){
      const aiCorrect = Math.random()>0.35;
      document.getElementById('opponentStatus').textContent = aiCorrect?'ğŸ¤– Ø£Ø¬Ø§Ø¨!':'ğŸ¤– ÙÙƒÙ‘Ø±...';
      if(aiCorrect){ arenaState.p2++; oppScoreEl.textContent=arenaState.p2; }
    }
    
    if(arenaState.qTimer<=0){
      clearInterval(arenaState.timer);
      setTimeout(()=>{ arenaState.qIndex++; loadArenaQuestion(qs,myScoreEl,oppScoreEl); },800);
    }
  },1000);
}

function answerArena(chosen,correct){
  clearInterval(arenaState.timer);
  const qs = arenaQuestions[arenaState.subject]||arenaQuestions.general;
  const opts = document.querySelectorAll('.q-option');
  opts[correct].classList.add('correct');
  if(chosen!==correct) opts[chosen].classList.add('wrong');
  else { arenaState.p1++; document.getElementById('player1Score').textContent=arenaState.p1; }
  
  // AI always reacts after player answers
  if(arenaState.isSolo && Math.random()>0.5 && document.getElementById('opponentStatus').textContent===''){
    arenaState.p2++; document.getElementById('player2Score').textContent=arenaState.p2;
    document.getElementById('opponentStatus').textContent='ğŸ¤– Ø£Ø¬Ø§Ø¨ Ø£ÙŠØ¶Ø§Ù‹!';
  }
  
  setTimeout(()=>{ arenaState.qIndex++; loadArenaQuestion(qs,document.getElementById('player1Score'),document.getElementById('player2Score')); },1200);
}

async function endArena(myScoreEl, oppScoreEl){
  clearInterval(arenaState.timer);
  const myScore  = arenaState.p1;
  const oppScore = arenaState.p2;
  const won = myScore > oppScore;
  const draw = myScore === oppScore;
  
  document.getElementById('arenaGame').style.display='none';
  document.getElementById('arenaResult').style.display='block';
  document.getElementById('resultMyScore').textContent  = myScore;
  document.getElementById('resultOppScore').textContent = oppScore;
  
  if(draw){
    document.getElementById('resultEmoji').textContent='ğŸ¤';
    document.getElementById('resultTitle').textContent='ØªØ¹Ø§Ø¯Ù„!';
    document.getElementById('resultDesc').textContent='Ù…Ø¨Ø§Ø±Ø§Ø© Ù…ØªÙƒØ§ÙØ¦Ø©!';
  } else if(won){
    document.getElementById('resultEmoji').textContent='ğŸ†';
    document.getElementById('resultTitle').textContent='Ø§Ù†ØªØµØ±Øª!';
    document.getElementById('resultDesc').textContent='Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹ØŒ Ø§Ø³ØªÙ…Ø±!';
    userProfile.arenaWins=(userProfile.arenaWins||0)+1;
    userProfile.arenaRating=(userProfile.arenaRating||1000)+25;
    document.getElementById('arenaWins').textContent=userProfile.arenaWins;
    document.getElementById('arenaRating').textContent=userProfile.arenaRating;
  } else {
    document.getElementById('resultEmoji').textContent='ğŸ˜¤';
    document.getElementById('resultTitle').textContent='Ù„Ù… ØªÙØ² Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©!';
    document.getElementById('resultDesc').textContent='Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¯Ø±Ø¨ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!';
    userProfile.arenaRating=Math.max(900,(userProfile.arenaRating||1000)-10);
    document.getElementById('arenaRating').textContent=userProfile.arenaRating;
  }
  
  document.getElementById('arenaNotif').style.display='none';
  await saveProfile();
}

function backToLobby(){
  document.getElementById('arenaResult').style.display='none';
  document.getElementById('arenaLobby').style.display='block';
  // Reset scores display
  document.getElementById('player1Score').textContent='0';
  document.getElementById('player2Score').textContent='0';
}

/* =========================================================
   NAVIGATION & UTILITIES
   ========================================================= */
function goPage(pageId){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.dataset.page===pageId));
  window.scrollTo(0,0);
  if(pageId==='pageGroup') document.getElementById('groupNotif').style.display='none';
  if(pageId==='pageMizan') updateMizanPage();
}

function setLang(lang){
  currentLang=lang;
  document.documentElement.setAttribute('lang',lang);
  document.documentElement.setAttribute('dir',lang==='ar'?'rtl':'ltr');
  document.documentElement.setAttribute('data-lang',lang);
  document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.textContent.trim()===(lang==='ar'?'Ø¹Ø±Ø¨ÙŠ':'EN')));
  if(userProfile.schedule?.length) renderSchedule();
  renderSubjects();
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

/* =========================================================
   CLEANUP ON PAGE UNLOAD
   ========================================================= */
window.addEventListener('beforeunload',()=>{
  if(currentRoomId && currentUser){
    rtdb.ref(`rooms/${currentRoomId}/members/${currentUser.uid}`).remove();
  }
  if(currentUser){
    rtdb.ref('online/'+currentUser.uid).remove();
  }
});

// Init
updatePomUI();
</script>

</body>
</html>
